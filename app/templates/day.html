{# app/templates/day.html #}
{% extends "base.html" %}

{% block title %}Periodical – {{ date }}{% if person_name %} – {{ person_name }}{% endif %}{% endblock %}

{% block page_content %}

    <div class="day-buttons-bar">
        <div class="day-buttons-left">
            <a href="/day/{{ person_id }}/{{ prev_year }}/{{ prev_month }}/{{ prev_day }}"
               class="btn btn-primary">
                Previous day
            </a>
            <a href="/week/{{ person_id }}?year={{ iso_year }}&week={{ iso_week }}"
               class="btn btn-primary">
                Back to week
            </a>
            <a href="/day/{{ person_id }}/{{ next_year }}/{{ next_month }}/{{ next_day }}"
               class="btn btn-primary">
                Next day
            </a>
            <input type="date"
                   id="date-picker"
                   class="date-picker-input"
                   value="{{ date }}"
                   onchange="window.location.href='/day/{{ person_id }}/' + this.value.replace(/-/g, '/')">
        </div>

        <div class="day-buttons-right">
            {# Navigering mellan personer - endast för admin #}
            {% if user and user.role.value == 'admin' %}
                {% for i in person_ids %}
                    <a href="/day/{{ i }}/{{ date.year }}/{{ date.month }}/{{ date.day }}"
                       class="btn secondary btn-person {% if i == person_id %}btn-person-active{% endif %}">
                        {{ i }}
                    </a>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <div class="day-header">
        <h2>
            {{ weekday_name }} {{ date }} - {{ person_name }} ({{ person_id }})
            {% if show_salary and is_storhelg %}
                <span class="badge-ob5">Storhelg</span>
            {% endif %}
        </h2>
    </div>

    <!-- Shift -->
    <div class="day-layout">
        <section class="day-section">
            <h3>Shift</h3>
            <table>
                <thead>
                    <tr>
                        <th>Rotation week</th>
                        <th>Shift code</th>
                        <th>Name</th>
                        <th>Time</th>
                        <th>Total hours</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="shift-row"
                        style="border-left:6px solid {% if shift %}{{ shift.color }}{% else %}transparent{% endif %};">
                        <td>{% if rotation_week and rotation_length %}{{ rotation_week }}/{{ rotation_length }}{% else %}-{% endif %}</td>
                        <td>
                            {% if shift %}
                                <span class="badge"
                                      style="background: {{ shift.color }}; color: {{ shift.color | contrast }};">
                                    {{ shift.code }}
                                </span>
                            {% else %}
                                <span class="badge badge-off">OFF</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if shift %}
                                {{ shift.label }}
                            {% else %}
                                No shift
                            {% endif %}
                        </td>
                        <td>
                            {% if shift and shift.start_time %}
                                {{ shift.start_time }} to {{ shift.end_time }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ "%.2f"|format(hours) if hours else "0.00" }}</td>
                    </tr>
                    {% if coworkers %}
                    <tr>
                        <td colspan="5" class="coworkers-row">
                            <strong>Arbetar med:</strong> {{ coworkers | join(', ') }}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            <h3>Övertid (OT)</h3>

            {% if ot_shift %}
                {% if ot_shift.is_extension %}
                    {# Förlängning av ordinarie skift #}
                    <div class="ot-display">
                        <table>
                            <thead>
                                <tr>
                                    <th>Typ</th>
                                    <th>Start</th>
                                    <th>Slut</th>
                                    <th>Extra tid</th>
                                    <th>Timlön</th>
                                    <th>OT-lön</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="badge" style="background:#f59e0b;color:#000;">Förlängning</span></td>
                                    <td>{{ ot_shift.start_time }}</td>
                                    <td>{{ ot_shift.end_time }}</td>
                                    <td>{{ "%.2f"|format(ot_shift.hours) }} h</td>
                                    <td>{{ "%.2f"|format(ot_shift.hourly_rate) }} kr/h</td>
                                    <td>{{ "%.2f"|format(ot_shift.pay) }} kr</td>
                                    <td>
                                        <form method="POST" action="/overtime/{{ ot_shift_id }}/delete" style="display: inline;">
                                            <button type="submit" class="btn btn-danger" onclick="return confirm('Ta bort förlängning?')">Ta bort</button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    {# Inkallat övertidspass #}
                    <div class="ot-display">
                        <table>
                            <thead>
                                <tr>
                                    <th>Start</th>
                                    <th>Slut</th>
                                    <th>Timmar</th>
                                    <th>Timlön</th>
                                    <th>OT-lön</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ ot_shift.start_time }}</td>
                                    <td>{{ ot_shift.end_time }}</td>
                                    <td>{{ "%.2f"|format(ot_shift.hours) }}</td>
                                    <td>{{ "%.2f"|format(ot_shift.hourly_rate) }} kr/h</td>
                                    <td>{{ "%.2f"|format(ot_shift.pay) }} kr</td>
                                    <td>
                                        <form method="POST" action="/overtime/{{ ot_shift_id }}/delete" style="display: inline;">
                                            <button type="submit" class="btn btn-danger" onclick="return confirm('Ta bort övertidspass?')">Ta bort</button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        {% if original_shift and original_shift.code == 'OC' %}
                        <p class="info-text">
                            <strong>OC-pass avslutas:</strong> OC-lön 00:00-{{ ot_shift.start_time }}, sedan OT-lön {{ ot_shift.start_time }}-{{ ot_shift.end_time }}
                        </p>
                        {% endif %}
                    </div>
                {% endif %}
            {% else %}
                {# Förlängningsformulär för ordinarie arbetspass #}
                {% if shift and shift.code in ('N1', 'N2', 'N3') %}
                    <p class="info-text" style="margin-bottom:0.5rem;">Stannade du kvar efter {{ shift.end_time }}? Logga förlängning:</p>
                    <form method="POST" action="/overtime/add" class="ot-form" id="ext-form">
                        <input type="hidden" name="user_id" value="{{ person_id }}">
                        <input type="hidden" name="date" value="{{ date }}">
                        <input type="hidden" name="is_extension" value="true">

                        <div class="form-row">
                            <div class="form-group">
                                <label for="ext_start_time">Ordinarie slut:</label>
                                <input type="time" id="ext_start_time" name="start_time" value="{{ shift.end_time }}" readonly style="opacity:0.6;">
                            </div>
                            <div class="form-group">
                                <label for="ext_end_time">Faktisk sluttid:</label>
                                <input type="time" id="ext_end_time" name="end_time" value="{{ shift.end_time }}" required>
                            </div>
                            <div class="form-group">
                                <label for="ext_hours">Timmar:</label>
                                <input type="number" id="ext_hours" name="hours" value="0" step="0.01" min="0.01" max="8" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Logga förlängning</button>
                    </form>

                    <script>
                    (function() {
                        var startInput = document.getElementById('ext_start_time');
                        var endInput = document.getElementById('ext_end_time');
                        var hoursInput = document.getElementById('ext_hours');

                        function updateHours() {
                            var start = startInput.value, end = endInput.value;
                            if (!start || !end) return;
                            var sm = parseInt(start.split(':')[0]) * 60 + parseInt(start.split(':')[1]);
                            var em = parseInt(end.split(':')[0]) * 60 + parseInt(end.split(':')[1]);
                            var diff = em - sm;
                            if (diff > 0) hoursInput.value = (diff / 60).toFixed(2);
                        }
                        endInput.addEventListener('change', updateHours);
                    })();
                    </script>

                    <p class="info-text">Övertidslön beräknas som månadslön / 72 per timme.</p>
                {% endif %}

                {# Fullt övertidspass (inkallning) #}
                <form method="POST" action="/overtime/add" class="ot-form" style="margin-top: {% if shift and shift.code in ('N1', 'N2', 'N3') %}1.5rem{% else %}0{% endif %};">
                    <input type="hidden" name="user_id" value="{{ person_id }}">
                    <input type="hidden" name="date" value="{{ date }}">

                    <details>
                        <summary style="cursor:pointer; color: var(--text-muted); font-size:0.9rem;">Lägg till inkallat övertidspass...</summary>
                        <div class="form-row" style="margin-top:0.75rem;">
                            <div class="form-group">
                                <label for="start_time">Starttid:</label>
                                <input type="time" id="start_time" name="start_time" value="14:00" required>
                            </div>
                            <div class="form-group">
                                <label for="end_time">Sluttid:</label>
                                <input type="time" id="end_time" name="end_time" value="22:30" required>
                            </div>
                            <div class="form-group">
                                <label for="hours">Timmar:</label>
                                <input type="number" id="hours" name="hours" value="8.5" step="0.5" min="0.5" max="24" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Lägg till övertidspass</button>
                    </details>
                </form>

                <p class="info-text">
                    Övertidslön beräknas som månadslön / 72 per timme.
                </p>
            {% endif %}

        {# Frånvarosection - endast för egen sida när inloggad #}
        {% if user and user.id == person_id or user.id == 0 %}
            <h3>Frånvaro</h3>
            
            {% if absence %}
                <div class="absence-display">
                    <table>
                        <thead>
                            <tr>
                                <th>Typ</th>
                                <th>Färg</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    {% if absence.absence_type.value == 'SICK' %}
                                        Sjuk
                                    {% elif absence.absence_type.value == 'VAB' %}
                                        VAB (Vård av barn)
                                    {% elif absence.absence_type.value == 'LEAVE' %}
                                        Ledigt (obetald)
                                    {% elif absence.absence_type.value == 'OFF' %}
                                        Ledig (betald)
                                    {% else %}
                                        {{ absence.absence_type.value }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if absence.absence_type.value == 'SICK' %}
                                        <span class="badge" style="background: #ef4444; color: white;">Sjuk</span>
                                    {% elif absence.absence_type.value == 'VAB' %}
                                        <span class="badge" style="background: #f97316; color: white;">VAB</span>
                                    {% elif absence.absence_type.value == 'LEAVE' %}
                                        <span class="badge" style="background: #a855f7; color: white;">Ledigt</span>
                                    {% elif absence.absence_type.value == 'OFF' %}
                                        <span class="badge" style="background: #888888; color: white;">Ledig</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="POST" action="/absence/{{ absence.id }}/delete" style="display: inline;">
                                        <button type="submit" class="btn btn-danger" onclick="return confirm('Ta bort frånvaro?')">Ta bort</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    {% if show_salary and absence_deduction > 0 %}
                    <h3>Löneavdrag</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Timmar</th>
                                <th>Avdrag</th>
                                <th>Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ "%.2f"|format(absence_shift_hours) }} h</td>
                                <td>{{ "%.2f"|format(absence_deduction) }} kr</td>
                                <td>
                                    {% if absence.absence_type.value == 'SICK' %}
                                        {% if is_karens %}
                                            <span class="badge" style="background: #dc2626; color: white;">Karensdag (100% avdrag)</span>
                                        {% else %}
                                            20% avdrag (80% sjuklön från arbetsgivaren)
                                        {% endif %}
                                    {% elif absence.absence_type.value == 'VAB' %}
                                        100% avdrag (ersättning från Försäkringskassan)
                                    {% elif absence.absence_type.value == 'LEAVE' %}
                                        100% avdrag (obetald ledighet)
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    {% endif %}
                    
                    <p class="info-text">
                        Frånvaro registrerad. Detta ersätter det schemalagda skiftet för denna dag.
                    </p>
                </div>
            {% else %}
                <form method="POST" action="/absence/add" class="absence-form">
                    <input type="hidden" name="user_id" value="{{ person_id }}">
                    <input type="hidden" name="date" value="{{ date }}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="absence_type">Typ av frånvaro:</label>
                            <select id="absence_type" name="absence_type" required>
                                <option value="">-- Välj typ --</option>
                                <option value="SICK">Sjuk</option>
                                <option value="VAB">VAB (Vård av barn)</option>
                                <option value="LEAVE">Ledigt (obetald)</option>
                                <option value="OFF">Ledig (betald)</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Lägg till frånvaro</button>
                </form>
                
                <p class="info-text">
                    Registrera frånvaro för att ersätta det schemalagda skiftet.
                    <br>
                    <strong>Sjuk:</strong> Ger sjuklön efter första dagen (röd färg)
                    <br>
                    <strong>VAB:</strong> Vård av barn (orange färg)
                    <br>
                    <strong>Ledigt (obetald):</strong> Permission eller annan ledighet med löneavdrag (lila färg)
                    <br>
                    <strong>Ledig (betald):</strong> Ledig dag utan löneavdrag (grå färg)
                </p>
            {% endif %}
        {% endif %}

        {# Beredskapssection - endast för egen sida när inloggad #}
        {% if user and user.id == person_id or user.id == 0 %}
            <h3>Beredskap (On-call)</h3>

            {% if oncall_override %}
                <div class="oncall-override-display">
                    <table>
                        <thead>
                            <tr>
                                <th>Typ</th>
                                <th>Anledning</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    {% if oncall_override.override_type.value == 'ADD' %}
                                        <span class="badge" style="background: #22c55e; color: white;">Tillagd OC</span>
                                    {% else %}
                                        <span class="badge" style="background: #ef4444; color: white;">Borttagen OC</span>
                                    {% endif %}
                                </td>
                                <td>{{ oncall_override.reason or '-' }}</td>
                                <td>
                                    <form method="POST" action="/oncall/{{ oncall_override.id }}/delete" style="display: inline;">
                                        <button type="submit" class="btn btn-danger" onclick="return confirm('Ångra ändringen och återställ till rotation?')">Ångra</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="info-text">
                        {% if oncall_override.override_type.value == 'ADD' %}
                            Beredskapspass har lagts till manuellt. Klicka "Ångra" för att ta bort.
                        {% else %}
                            Beredskapspass har tagits bort manuellt från rotationen. Klicka "Ångra" för att återställa.
                        {% endif %}
                    </p>
                </div>
            {% else %}
                {% if has_rotation_oc %}
                    {# Person har OC enligt rotation - visa ta bort-knapp #}
                    <form method="POST" action="/oncall/remove" class="oncall-form">
                        <input type="hidden" name="user_id" value="{{ person_id }}">
                        <input type="hidden" name="date" value="{{ date }}">

                        <div class="form-row">
                            <div class="form-group">
                                <label for="reason">Anledning (valfritt):</label>
                                <input type="text" id="reason" name="reason" placeholder="T.ex. sjuk, byte med kollega">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-danger">Ta bort beredskapspass</button>
                    </form>

                    <p class="info-text">
                        Du har beredskap denna dag enligt rotationsschemat.
                        <br>
                        Ta bort om du inte kan ha beredskap (t.ex. vid sjukdom eller byte med kollega).
                    </p>
                {% else %}
                    {# Person har inte OC - visa lägg till-knapp #}
                    <form method="POST" action="/oncall/add" class="oncall-form">
                        <input type="hidden" name="user_id" value="{{ person_id }}">
                        <input type="hidden" name="date" value="{{ date }}">

                        <div class="form-row">
                            <div class="form-group">
                                <label for="reason">Anledning (valfritt):</label>
                                <input type="text" id="reason" name="reason" placeholder="T.ex. byte med kollega">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Lägg till beredskapspass</button>
                    </form>

                    <p class="info-text">
                        Du har inte beredskap denna dag enligt rotationsschemat.
                        <br>
                        Lägg till om du tar över beredskap från en kollega.
                    </p>
                {% endif %}
            {% endif %}
        {% endif %}

        <h3>Alla som arbetar denna dag</h3>
        {% if all_working_persons and all_working_persons|length > 0 %}
            <table>
                <thead>
                    <tr>
                        <th>Namn</th>
                        <th>Skift</th>
                    </tr>
                </thead>
                <tbody>
                {% for p in all_working_persons %}
                    <tr>
                        <td>{{ p[0] }}</td>
                        <td>{{ p[1] }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}

        {% if swap_users and user and user.id == person_id %}
        <h3 style="margin-top: 1.5rem;">Föreslå skiftbyte</h3>
        <form method="POST" action="/swaps/propose" class="ot-form" id="swap-form">
            <input type="hidden" name="requester_date" value="{{ date }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="target_id">Byt med:</label>
                    <select id="target_id" name="target_id" required>
                        <option value="">-- Välj kollega --</option>
                        {% for u in swap_users %}
                        <option value="{{ u.id }}">{{ u.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="target_date">Deras pass:</label>
                    <select id="target_date" name="target_date" required disabled>
                        <option value="">-- Välj kollega först --</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="swap_message">Meddelande (valfritt):</label>
                    <input type="text" id="swap_message" name="message" placeholder="T.ex. kan jag ta ditt pass?">
                </div>
            </div>
            <button type="submit" class="btn" id="swap-submit" disabled>Föreslå byte</button>
            <p class="info-text">
                Du erbjuder ditt pass denna dag
                {% if shift %}
                    ({{ shift.code }}{% if ob_hours %}, {{ "%.1f"|format(ob_hours.values()|sum) }}h OB{% endif %})
                {% endif %}
                och väljer vilket av kollegans pass du vill ta.
            </p>
        </form>
        <script>
            document.getElementById('target_id').addEventListener('change', function() {
                const userId = this.value;
                const targetSelect = document.getElementById('target_date');
                const submitBtn = document.getElementById('swap-submit');

                if (!userId) {
                    targetSelect.innerHTML = '<option value="">-- Välj kollega först --</option>';
                    targetSelect.disabled = true;
                    submitBtn.disabled = true;
                    return;
                }

                targetSelect.innerHTML = '<option value="">Laddar pass...</option>';
                targetSelect.disabled = true;

                const offering = '{{ shift.code if shift else "OFF" }}';
                const refDate = '{{ date }}';
                fetch('/swaps/api/shifts/' + userId + '?offering=' + offering + '&ref_date=' + refDate)
                    .then(r => r.json())
                    .then(data => {
                        if (data.shifts.length === 0) {
                            targetSelect.innerHTML = '<option value="">Inga kommande pass</option>';
                            submitBtn.disabled = true;
                            return;
                        }
                        let html = '<option value="">-- Välj pass --</option>';
                        data.shifts.forEach(s => {
                            const ob = s.ob_hours > 0 ? ' (' + s.ob_hours + 'h OB)' : '';
                            html += '<option value="' + s.date + '">' + s.date_display + ': ' + s.label + ob + '</option>';
                        });
                        targetSelect.innerHTML = html;
                        targetSelect.disabled = false;
                        submitBtn.disabled = false;
                    });
            });
        </script>
        {% endif %}
        </section>

        {% if show_salary %}
            <section class="day-section">
            {% if is_effective_oc %}
            {# On-call compensation section - for effective OC shifts (including ADD overrides) #}
                <h3>Oncall pay</h3>
                {% set oncall = oncall_details %}
                {% if oncall and oncall.breakdown %}
                    <table>
                        <thead>
                            <tr>
                                <th class="th_left">Type</th>
                                <th class="th_center">Hours</th>
                                <th class="th_center">Pay</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for code, details in oncall.breakdown.items() %}
                                <tr>
                                    <td class="td_left">{{ details.label }}</td>
                                    <td class="td_right num">{{ "%.2f"|format(details.hours) }}</td>
                                    <td class="td_right num">{{ "%.2f"|format(details.pay) }} kr</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td class="td_left foot_left"><strong>Total</strong></td>
                                <td class="td_right foot_right num"><strong>{{ "%.2f"|format(oncall.total_hours) }}</strong></td>
                                <td class="td_right foot_right num"><strong>{{ "%.2f"|format(oncall_pay) }} kr</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                {% else %}
                    <p>No on-call compensation details available.</p>
                {% endif %}
            {% else %}
            {# Regular OB section for non-OC shifts #}
                <h3>OB hours</h3>
                {% if ob_codes %}
                    {% set total_ob_hours = ob_hours.values() | sum %}
                    {# Create a mapping of code to label from ob_rules #}
                    {% set ob_labels = {} %}
                    {% for rule in ob_rules %}
                        {% if rule.code not in ob_labels %}
                            {% set _ = ob_labels.update({rule.code: rule.label}) %}
                        {% endif %}
                    {% endfor %}
                    <table>
                        <thead>
                            <tr>
                                <th>OB type</th>
                                <th class="th_right">Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for code in ob_codes %}
                                <tr>
                                    <td class="num">{{ ob_labels.get(code, code) }}</td>
                                    <td class="td_right num">{{ "%.2f"|format(ob_hours.get(code, 0.0)) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td class="foot_left"><strong>Total OB hours</strong></td>
                                <td class="td_right foot_right num"><strong>{{ "%.2f"|format(total_ob_hours) }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                {% else %}
                    <p>No OB hours this day.</p>
                {% endif %}

            <h3>OB pay</h3>
            {% if ob_codes %}
                {% set total_ob_pay = ob_pay.values() | sum %}
                {# Create a mapping of code to label from ob_rules #}
                {% set ob_labels = {} %}
                {% for rule in ob_rules %}
                    {% if rule.code not in ob_labels %}
                        {% set _ = ob_labels.update({rule.code: rule.label}) %}
                    {% endif %}
                {% endfor %}
                <table>
                    <thead>
                        <tr>
                            <th class="th_left">OB type</th>
                            <th class="th_right">Amount (SEK)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for code in ob_codes %}
                            <tr>
                                <td class="num">{{ ob_labels.get(code, code) }}</td>
                                <td class="td_right num">{{ "%.2f"|format(ob_pay.get(code, 0.0)) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="foot_left num"><strong>Total OB pay</strong></td>
                            <td class="td_right foot_right num"><strong>{{ "%.2f"|format(total_ob_pay) }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            {% else %}
                <p>No OB compensation this day.</p>
            {% endif %}

            <h3>Active OB rules</h3>
            {% if active_special_rules and active_special_rules|length > 0 %}
                <table>
                    <thead>
                        <tr>
                            <th class="th_left">Code</th>
                            <th class="th_left">Label</th>
                            <th class="th_left">Time</th>
                            <th class="th_right">Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rule in active_special_rules %}
                            <tr>
                                <td class="td_left num">{{ rule.code }}</td>
                                <td class="td_left num">{{ rule.label }}</td>
                                <td class="td_left num">{{ rule.start_time }} to {{ rule.end_time }}</td>
                                <td class="td_right num">{{ rule.rate }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No special OB rules active this day.</p>
            {% endif %}
        </section>
        {% endif %}
        {% endif %}


    </div>

{% endblock %}
