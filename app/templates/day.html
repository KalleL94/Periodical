{# app/templates/day.html #}
{% extends "base.html" %}

{% block page_content %}

    <div class="day-buttons-bar">
        <div class="day-buttons-left">
            <a href="/day/{{ person_id }}/{{ prev_year }}/{{ prev_month }}/{{ prev_day }}"
               class="btn btn-primary">
                Previous day
            </a>
            <a href="/week/{{ person_id }}?year={{ iso_year }}&week={{ iso_week }}"
               class="btn btn-primary">
                Back to week
            </a>
            <input type="date"
                   id="date-picker"
                   class="date-picker-input"
                   value="{{ date }}"
                   onchange="window.location.href='/day/{{ person_id }}/' + this.value.replace(/-/g, '/')">
            <a href="/day/{{ person_id }}/{{ next_year }}/{{ next_month }}/{{ next_day }}"
               class="btn btn-primary">
                Next day
            </a>
        </div>

        <div class="day-buttons-right">
            {# Navigering mellan personer - endast för admin #}
            {% if user and user.role.value == 'admin' %}
                {% for i in range(1, 10 + 1) %}
                    <a href="/day/{{ i }}/{{ date.year }}/{{ date.month }}/{{ date.day }}"
                       class="btn secondary btn-person {% if i == person_id %}btn-person-active{% endif %}">
                        {{ i }}
                    </a>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <div class="day-header">
        <h2>
            {{ weekday_name }} {{ date }} - {{ person_name }} ({{ person_id }})
            {% if show_salary and is_storhelg %}
                <span class="badge-ob5">Storhelg</span>
            {% endif %}
        </h2>
    </div>

    <div class="day-layout">
        <section class="day-section">
            <h3>Shift</h3>
            <table>
                <thead>
                    <tr>
                        <th>Rotation week</th>
                        <th>Shift code</th>
                        <th>Name</th>
                        <th>Time</th>
                        <th>Total hours</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="shift-row"
                        style="border-left:6px solid {% if shift %}{{ shift.color }}{% else %}transparent{% endif %};">
                        <td>{{ rotation_week if rotation_week else "-" }}</td>
                        <td>
                            {% if shift %}
                                <span class="badge"
                                      style="background: {{ shift.color }}; color: {{ shift.color | contrast }};">
                                    {{ shift.code }}
                                </span>
                            {% else %}
                                <span class="badge badge-off">OFF</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if shift %}
                                {{ shift.label }}
                            {% else %}
                                No shift
                            {% endif %}
                        </td>
                        <td>
                            {% if shift and shift.start_time %}
                                {{ shift.start_time }} to {{ shift.end_time }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ "%.2f"|format(hours) if hours else "0.00" }}</td>
                    </tr>
                </tbody>
            </table>
        </section>

        {% if show_salary %}
        {% if original_shift and original_shift.code == 'OC' %}
        {# On-call compensation section - only for OC shifts (check original_shift to handle OT replacement) #}
        <section class="day-section">
            <h3>Oncall pay</h3>
            {% set oncall = oncall_details %}
            {% if oncall and oncall.breakdown %}
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Hours</th>
                            <th>Pay</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for code, details in oncall.breakdown.items() %}
                        <tr>
                            <td>{{ details.label }}</td>
                            <td>{{ "%.2f"|format(details.hours) }}</td>
                            <td>{{ "%.2f"|format(details.pay) }} kr</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Total</th>
                            <th>{{ "%.2f"|format(oncall.total_hours) }}</th>
                            <th>{{ "%.2f"|format(oncall_pay) }} kr</th>
                        </tr>
                    </tfoot>
                </table>
            {% else %}
                <p>No on-call compensation details available.</p>
            {% endif %}
        </section>
        {% else %}
        {# Regular OB section for non-OC shifts #}
        <section class="day-section">
            <h3>OB hours</h3>
            {% if ob_codes %}
                {% set total_ob_hours = ob_hours.values() | sum %}
                <table>
                    <thead>
                        <tr>
                            <th>OB code</th>
                            <th>Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for code in ob_codes %}
                            <tr>
                                <td>{{ code }}</td>
                                <td>{{ "%.2f"|format(ob_hours.get(code, 0.0)) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Total OB hours</th>
                            <th>{{ "%.2f"|format(total_ob_hours) }}</th>
                        </tr>
                    </tfoot>
                </table>
            {% else %}
                <p>No OB hours this day.</p>
            {% endif %}

            <h3>OB pay</h3>
            {% if ob_codes %}
                {% set total_ob_pay = ob_pay.values() | sum %}
                <table>
                    <thead>
                        <tr>
                            <th>OB code</th>
                            <th>Amount (SEK)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for code in ob_codes %}
                            <tr>
                                <td>{{ code }}</td>
                                <td>{{ "%.2f"|format(ob_pay.get(code, 0.0)) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Total OB pay</th>
                            <th>{{ "%.2f"|format(total_ob_pay) }}</th>
                        </tr>
                    </tfoot>
                </table>
            {% else %}
                <p>No OB compensation this day.</p>
            {% endif %}

            <h3>Active OB rules</h3>
            {% if active_special_rules and active_special_rules|length > 0 %}
                <table>
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Label</th>
                            <th>Time</th>
                            <th>Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rule in active_special_rules %}
                            <tr>
                                <td>{{ rule.code }}</td>
                                <td>{{ rule.label }}</td>
                                <td>{{ rule.start_time }} to {{ rule.end_time }}</td>
                                <td>{{ rule.rate }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No special OB rules active this day.</p>
            {% endif %}
        </section>
        {% endif %}

        <section class="day-section">
            <h3>Övertidspass (OT)</h3>

            {% if ot_shift %}
                <div class="ot-display">
                    <table>
                        <thead>
                            <tr>
                                <th>Start</th>
                                <th>Slut</th>
                                <th>Timmar</th>
                                <th>Timlön</th>
                                <th>OT-lön</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ ot_shift.start_time }}</td>
                                <td>{{ ot_shift.end_time }}</td>
                                <td>{{ "%.2f"|format(ot_shift.hours) }}</td>
                                <td>{{ "%.2f"|format(monthly_salary / 72) }} kr/h</td>
                                <td>{{ "%.2f"|format(ot_shift.pay) }} kr</td>
                                <td>
                                    <form method="POST" action="/overtime/{{ ot_shift_id }}/delete" style="display: inline;">
                                        <button type="submit" class="btn btn-danger" onclick="return confirm('Ta bort övertidspass?')">Ta bort</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    {% if original_shift and original_shift.code == 'OC' %}
                    <p class="info-text">
                        <strong>OC-pass avslutas:</strong> OC-lön 00:00-{{ ot_shift.start_time }}, sedan OT-lön {{ ot_shift.start_time }}-{{ ot_shift.end_time }}
                    </p>
                    {% endif %}
                </div>
            {% else %}
                <form method="POST" action="/overtime/add" class="ot-form">
                    <input type="hidden" name="user_id" value="{{ person_id }}">
                    <input type="hidden" name="date" value="{{ date }}">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="start_time">Starttid:</label>
                            <input type="time" id="start_time" name="start_time" value="14:00" required>
                        </div>

                        <div class="form-group">
                            <label for="end_time">Sluttid:</label>
                            <input type="time" id="end_time" name="end_time" value="22:30" required>
                        </div>

                        <div class="form-group">
                            <label for="hours">Timmar:</label>
                            <input type="number" id="hours" name="hours" value="8.5" step="0.5" min="0.5" max="24" required>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Lägg till övertidspass</button>
                </form>

                <p class="info-text">
                    Övertidslön beräknas som månadslön / 72 per timme.
                </p>
            {% endif %}
        </section>
        {% endif %}

        {# Frånvarosection - endast för egen sida när inloggad #}
        {% if user and user.id == person_id or user.id == 0 %}
        <section class="day-section">
            <h3>Frånvaro</h3>
            
            {% if absence %}
                <div class="absence-display">
                    <table>
                        <thead>
                            <tr>
                                <th>Typ</th>
                                <th>Färg</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    {% if absence.absence_type.value == 'SICK' %}
                                        Sjuk
                                    {% elif absence.absence_type.value == 'VAB' %}
                                        VAB (Vård av barn)
                                    {% elif absence.absence_type.value == 'LEAVE' %}
                                        Ledigt (obetald)
                                    {% elif absence.absence_type.value == 'OFF' %}
                                        Ledig (betald)
                                    {% else %}
                                        {{ absence.absence_type.value }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if absence.absence_type.value == 'SICK' %}
                                        <span class="badge" style="background: #ef4444; color: white;">Sjuk</span>
                                    {% elif absence.absence_type.value == 'VAB' %}
                                        <span class="badge" style="background: #f97316; color: white;">VAB</span>
                                    {% elif absence.absence_type.value == 'LEAVE' %}
                                        <span class="badge" style="background: #a855f7; color: white;">Ledigt</span>
                                    {% elif absence.absence_type.value == 'OFF' %}
                                        <span class="badge" style="background: #888888; color: white;">Ledig</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="POST" action="/absence/{{ absence.id }}/delete" style="display: inline;">
                                        <button type="submit" class="btn btn-danger" onclick="return confirm('Ta bort frånvaro?')">Ta bort</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    {% if show_salary and absence_deduction > 0 %}
                    <h3>Löneavdrag</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Timmar</th>
                                <th>Avdrag</th>
                                <th>Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ "%.2f"|format(absence_shift_hours) }} h</td>
                                <td>{{ "%.2f"|format(absence_deduction) }} kr</td>
                                <td>
                                    {% if absence.absence_type.value == 'SICK' %}
                                        {% if is_karens %}
                                            <span class="badge" style="background: #dc2626; color: white;">Karensdag (100% avdrag)</span>
                                        {% else %}
                                            20% avdrag (80% sjuklön från arbetsgivaren)
                                        {% endif %}
                                    {% elif absence.absence_type.value == 'VAB' %}
                                        100% avdrag (ersättning från Försäkringskassan)
                                    {% elif absence.absence_type.value == 'LEAVE' %}
                                        100% avdrag (obetald ledighet)
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    {% endif %}
                    
                    <p class="info-text">
                        Frånvaro registrerad. Detta ersätter det schemalagda skiftet för denna dag.
                    </p>
                </div>
            {% else %}
                <form method="POST" action="/absence/add" class="absence-form">
                    <input type="hidden" name="user_id" value="{{ person_id }}">
                    <input type="hidden" name="date" value="{{ date }}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="absence_type">Typ av frånvaro:</label>
                            <select id="absence_type" name="absence_type" required>
                                <option value="">-- Välj typ --</option>
                                <option value="SICK">Sjuk</option>
                                <option value="VAB">VAB (Vård av barn)</option>
                                <option value="LEAVE">Ledigt (obetald)</option>
                                <option value="OFF">Ledig (betald)</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Lägg till frånvaro</button>
                </form>
                
                <p class="info-text">
                    Registrera frånvaro för att ersätta det schemalagda skiftet.
                    <br>
                    <strong>Sjuk:</strong> Ger sjuklön efter första dagen (röd färg)
                    <br>
                    <strong>VAB:</strong> Vård av barn (orange färg)
                    <br>
                    <strong>Ledigt (obetald):</strong> Permission eller annan ledighet med löneavdrag (lila färg)
                    <br>
                    <strong>Ledig (betald):</strong> Ledig dag utan löneavdrag (grå färg)
                </p>
            {% endif %}
        </section>
        {% endif %}
    </div>

{% endblock %}
