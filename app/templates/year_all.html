{# app/templates/year_all.html #}
{% extends "base.html" %}

{% block page_content %}

<div class="page-header">
    <div class="page-header-left">
        <a href="/year?year={{ year - 1 }}" class="btn btn-primary">Previous year</a>
        <a href="/year" class="btn btn-primary">Today</a>
        <a href="/year?year={{ year + 1 }}" class="btn btn-primary">Next year</a>
    </div>

    <div class="page-header-right">
        {# Visa bara länk till egen year-sida, eller alla om admin #}
        {% if user and user.role.value == 'admin' %}
            {% for i in range(1, 11) %}
                <a href="/year/{{ i }}?year={{ year }}" class="btn secondary">{{ i }}</a>
            {% endfor %}
        {% elif user %}
            <a href="/year/{{ user.id }}?year={{ year }}" class="btn secondary">Mitt år</a>
        {% endif %}
    </div>
</div>

<h2 class="page-title">Year {{ year }} - All persons</h2>

    <div class="month-grid">
        <table class="month-schedule table-sticky">
            <thead>
                {# Visa OB-totaler endast om admin #}
                {% if user and user.role.value == 'admin' %}
                    <tr id="totals-row">
                        <th></th>
                        <th></th>
                        {% if days and days|length > 0 %}
                            {% for p in days[0].persons %}
                                <th class="num" id="total-{{ p.person_id }}">
                                    <span class="loading-spinner" style="color: #999; font-size: 0.9em;">...</span>
                                </th>
                            {% endfor %}
                        {% endif %}
                    </tr>
                {% endif %}
                <tr>
                    <th class="w-md">Day</th>
                    <th class="w-lg">Date</th>
                    {% if days and days|length > 0 %}
                        {% for p in days[0].persons %}
                            <th class="person-header">
                                {# Länka bara till egen sida eller om admin #}
                                {% if user and (user.role.value == 'admin' or user.id == p.person_id) %}
                                    <a href="/year/{{ p.person_id }}?year={{ year }}">
                                        {{ p.person_name }}<br>
                                        <small>(#{{ p.person_id }})</small>
                                    </a>
                                {% else %}
                                    {{ p.person_name }}<br>
                                    <small>(#{{ p.person_id }})</small>
                                {% endif %}
                            </th>
                        {% endfor %}
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for day in days %}
                    <tr class="shift-row {% if today is defined and day.date == today %}today-row{% endif %}">
                        <td class="day-cell">{{ day.weekday_name }}</td>
                        <td class="date-cell">{{ day.date }}</td>
                        {% for person in day.persons %}
                            <td style="border-left:6px solid {% if person.shift %}{{ person.shift.color }}{% else %}transparent{% endif %}; padding-left:8px;">
                                {% if person.shift %}
                                    {# Länka till day-sida bara om admin eller egen #}
                                    {% if user and (user.role.value == 'admin' or user.id == person.person_id) %}
                                        <a href="/day/{{ person.person_id }}/{{ day.date.year }}/{{ day.date.month }}/{{ day.date.day }}"
                                           style="text-decoration:none;">
                                    {% endif %}
                                        {% if person.shift.code == 'SEM' %}
                                            <span class="badge badge-sem"
                                                  title="Semester"
                                                  style="background: {{ person.shift.color }}; color: {{ person.shift.color | contrast }};">
                                                SEM
                                            </span>
                                        {% elif person.shift.code == 'OT' %}
                                            <span class="badge"
                                                  {% if person.start and person.end %}title="Övertid: {{ person.start.strftime('%H:%M') }} - {{ person.end.strftime('%H:%M') }}"{% endif %}
                                                  style="background: {{ person.shift.color }}; color: {{ person.shift.color | contrast }};">
                                                OT
                                            </span>
                                        {% else %}
                                            <span class="badge"
                                                  style="background: {{ person.shift.color }}; color: {{ person.shift.color | contrast }};">
                                                {{ person.shift.code }}
                                            </span>
                                        {% endif %}
                                    {% if user and (user.role.value == 'admin' or user.id == person.person_id) %}
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <span class="badge badge-off">OFF</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<script>
// Lazy-load OB totals via AJAX for better performance
document.addEventListener('DOMContentLoaded', function() {
    {% if user and user.role.value == 'admin' %}
    const year = {{ year }};
    const personIds = [
        {% if days and days|length > 0 %}
            {% for p in days[0].persons %}{{ p.person_id }}{% if not loop.last %}, {% endif %}{% endfor %}
        {% endif %}
    ];

    console.log('[Year View] Lazy-loading totals for', personIds.length, 'persons');

    // Fetch totals for each person
    personIds.forEach(personId => {
        fetch(`/api/year/${year}/totals/${personId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`[Year View] Loaded total for person ${personId}:`, data.total_ob);
                const totalCell = document.getElementById(`total-${personId}`);
                if (totalCell && data.total_ob !== null && data.total_ob !== undefined) {
                    totalCell.innerHTML = data.total_ob.toFixed(2);
                } else if (totalCell) {
                    totalCell.innerHTML = '-';
                }
            })
            .catch(error => {
                console.error(`[Year View] Error loading total for person ${personId}:`, error);
                const totalCell = document.getElementById(`total-${personId}`);
                if (totalCell) {
                    totalCell.innerHTML = '<span style="color: #f44336;">✗</span>';
                }
            });
    });
    {% endif %}
});
</script>

{% endblock %}
