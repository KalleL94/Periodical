{# app/templates/profile.html #}
{% extends "base.html" %}

{% block page_content %}

<h2 class="page-title">Min profil</h2>

<div class="row" style="gap: 24px; flex-wrap: wrap; align-items: flex-start;">
    
    <!-- Profil info -->
    <div class="col" style="min-width: 300px; flex: 1;">
        <div class="card">
            <h3 style="margin-top: 0;">Personuppgifter</h3>
            
            {% if error %}
                <div style="background: rgba(255,100,100,0.2); border: 1px solid var(--danger); padding: 12px; border-radius: var(--radius); margin-bottom: 16px;">
                    {{ error }}
                </div>
            {% endif %}
            
            <form method="POST" action="/profile">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; color: var(--muted);">Anv√§ndarnamn</label>
                    <input type="text" value="{{ user.username }}" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
                    <small style="color: var(--muted);">Kan inte √§ndras</small>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label for="name" style="display: block; margin-bottom: 6px; color: var(--muted);">Namn</label>
                    <input type="text" id="name" name="name" value="{{ user.name }}" required style="width: 100%; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label for="wage" style="display: block; margin-bottom: 6px; color: var(--muted);">M√•nadsl√∂n (SEK)</label>
                    <input type="number" id="wage" name="wage" value="{{ user.wage }}" required min="0" step="500" style="width: 100%; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label for="tax_table" style="display: block; margin-bottom: 6px; color: var(--muted);">Skattetabell (Nuvarande: {{ user.tax_table }})</label>
                    <select id="tax_table" name="tax_table" style="width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text);">
                        {% for table in available_tax_tables %}
                        <option value="{{ table }}" {% if user.tax_table == table %}selected{% endif %}>Tabell {{ table }}</option>
                        {% endfor %}
                    </select>
                    <small style="color: var(--muted);">V√§lj din skattetabell enligt Skatteverket</small>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; color: var(--muted);">Roll</label>
                    <input type="text" value="{{ user.role.value }}" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
                </div>
                
                <button type="submit" class="btn">Spara √§ndringar</button>
            </form>
        </div>
    </div>
    
    <!-- Byt l√∂senord -->
    <div class="col" style="min-width: 300px; flex: 1;">
        <div class="card">
            <h3 style="margin-top: 0;">Byt l√∂senord</h3>
            
            <form method="POST" action="/profile/password">
                <div style="margin-bottom: 16px;">
                    <label for="current_password" style="display: block; margin-bottom: 6px; color: var(--muted);">Nuvarande l√∂senord</label>
                    <input type="password" id="current_password" name="current_password" required style="width: 100%; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 24px;">
                    <label for="new_password" style="display: block; margin-bottom: 6px; color: var(--muted);">Nytt l√∂senord</label>
                    <input type="password" id="new_password" name="new_password" required minlength="6" style="width: 100%; box-sizing: border-box;">
                </div>
                
                <button type="submit" class="btn secondary">Byt l√∂senord</button>
            </form>
        </div>
        
        <!-- Semester l√§nk -->
        <div class="card" style="margin-top: 16px;">
            <h3 style="margin-top: 0;">Semester</h3>
            <p style="color: var(--muted);">Hantera dina semesterveckor.</p>
            <a href="/profile/vacation" class="btn">Hantera semester</a>
        </div>
    </div>

</div>

    <!-- L√∂nehistorik -->
    <section style="margin-top: 32px;">
        <h2>L√∂nehistorik</h2>

        {% if wage_history %}
            <div class="card">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">L√∂n (SEK)</th>
                            <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Fr√•n datum</th>
                            <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Till datum</th>
                            <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Status</th>
                            <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">√Ötg√§rd</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in wage_history %}
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 8px; font-weight: 500;">{{ "{:,}".format(record.wage).replace(',', ' ') }} SEK</td>
                            <td style="padding: 8px;">{{ record.effective_from }}</td>
                            <td style="padding: 8px;">
                                {% if record.effective_to %}
                                    {{ record.effective_to }}
                                {% else %}
                                    <span style="color: var(--muted); font-style: italic;">p√•g√•ende</span>
                                {% endif %}
                            </td>
                            <td style="padding: 8px;">
                                {% if record.is_current %}
                                    <span style="color: var(--success); font-weight: 500;">‚úì Aktuell</span>
                                {% else %}
                                    <span style="color: var(--muted);">Historisk</span>
                                {% endif %}
                            </td>
                            <td style="padding: 8px;">
                                {% if wage_history | length > 1 %}
                                    <form method="POST" action="/profile/delete-wage/{{ record.id }}" style="display: inline;" onsubmit="return confirm('√Ñr du s√§ker p√• att du vill ta bort denna l√∂nepost?');">
                                        <button type="submit" class="btn danger" style="padding: 4px 8px; font-size: 0.875rem;">Ta bort</button>
                                    </form>
                                {% else %}
                                    <span style="color: var(--muted); font-size: 0.875rem;">‚Äî</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="card">
                <p style="color: var(--muted);">Ingen l√∂nehistorik tillg√§nglig.</p>
            </div>
        {% endif %}

        <!-- Add New Wage -->
        <div class="card" style="margin-top: 16px;">
            <h3 style="margin-top: 0;">L√§gg till ny l√∂n</h3>
            <p style="color: var(--muted); margin-bottom: 16px;">
                L√§gg till en ny l√∂n med ett effektivt datum. Tidigare l√∂n kommer automatiskt att avslutas dagen innan. Detta √§r anv√§ndbart vid l√∂nerevision eller f√∂rhandling.
            </p>

            <form method="POST" action="/profile/add-wage">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label for="new_wage" style="display: block; margin-bottom: 6px; color: var(--muted);">Ny l√∂n (SEK)</label>
                        <input
                            type="number"
                            id="new_wage"
                            name="new_wage"
                            required
                            min="0"
                            step="500"
                            placeholder="t.ex. 35000"
                            style="width: 100%; box-sizing: border-box;"
                        >
                    </div>

                    <div>
                        <label for="effective_from" style="display: block; margin-bottom: 6px; color: var(--muted);">Fr√•n datum</label>
                        <input
                            type="date"
                            id="effective_from"
                            name="effective_from"
                            required
                            style="width: 100%; box-sizing: border-box;"
                        >
                    </div>
                </div>

                <button type="submit" class="btn">L√§gg till l√∂n</button>
            </form>
        </div>
    </section>

    <!-- Kalenderexport -->
    <section class="calendar-export">
        <h2>Kalenderexport</h2>
        <p class="export-description">
            Ladda ner ditt schema som .ics-fil f√∂r att importera till Google Calendar, Outlook eller Apple Calendar.
        </p>
        <a href="/profile/calendar.ics/sv" class="btn btn-secondary">
            üìÖ Exportera schema till kalender p√• svenska
        </a>
        <a href="/profile/calendar.ics/en" class="btn btn-secondary">
            üìÖ Exportera schema till kalender p√• engelska
        </a>
    </section>
{% endblock %}
