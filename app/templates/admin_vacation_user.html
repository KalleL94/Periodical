{# app/templates/admin_vacation_user.html #}
{% extends "base.html" %}

{% block page_content %}

<div class="page-header">
    <div class="page-header-left">
        <a href="/admin/vacation/{{ edit_user.id }}?year={{ year - 1 }}" class="btn secondary">{{ year - 1 }}</a>
        <span style="padding: 8px 16px; font-weight: 600;">{{ year }}</span>
        <a href="/admin/vacation/{{ edit_user.id }}?year={{ year + 1 }}" class="btn secondary">{{ year + 1 }}</a>
    </div>
    <div class="page-header-right">
        <a href="/admin/vacation?year={{ year }}" class="btn secondary">Tillbaka till &ouml;versikt</a>
    </div>
</div>

<h2 class="page-title">Semester: {{ edit_user.name }} {{ year }}</h2>

{% if success %}
<div style="background: rgba(100,255,100,0.2); border: 1px solid #4caf50; padding: 12px; border-radius: var(--radius); margin-bottom: 16px;">
    {{ success }}
</div>
{% endif %}

<div class="row" style="gap: 24px; flex-wrap: wrap; align-items: flex-start;">

    <!-- Left column: week grid + day-level -->
    <div class="col" style="min-width: 400px; flex: 2;">

        <!-- Balance Card -->
        <div class="card" style="margin-bottom: 16px;">
            <h3 style="margin-top: 0;">Semestersaldo</h3>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                <div style="text-align: center;">
                    <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 4px;">Tilldelade</div>
                    <div style="font-size: 1.3rem; font-weight: 700;">{{ balance.entitled_days }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 4px;">Sparade</div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: {% if balance.saved_from_previous > 0 %}var(--accent){% else %}var(--muted){% endif %};">{{ balance.saved_from_previous }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 4px;">Totalt</div>
                    <div style="font-size: 1.3rem; font-weight: 700;">{{ balance.total_available }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 4px;">Uttagna</div>
                    <div style="font-size: 1.3rem; font-weight: 700;">{{ balance.used_days }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 4px;">Kvar</div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: {% if balance.remaining_days > 5 %}var(--accent-2){% elif balance.remaining_days > 0 %}var(--warning){% else %}var(--danger){% endif %};">
                        {{ balance.remaining_days }}
                    </div>
                </div>
            </div>
            {% if balance.saved_breakdown %}
            <div style="margin-top: 8px; font-size: 0.75rem; color: var(--muted); text-align: center;">
                Sparade fr&aring;n: {% for s in balance.saved_breakdown %}{{ s.year }} ({{ s.days }}d){% if not loop.last %}, {% endif %}{% endfor %}
            </div>
            {% endif %}
            <div style="margin-top: 8px; font-size: 0.8rem; color: var(--muted); text-align: center;">
                Semester&aring;r: {{ balance.year_start | date_format }} &mdash; {{ balance.year_end | date_format }}
                {% if balance.is_first_year %}<span style="color: var(--warning);"> (f&ouml;rsta &aring;ret, proportionellt)</span>{% endif %}
            </div>
            {% if balance.week_based_used > 0 or balance.day_level_used > 0 %}
            <div style="margin-top: 6px; font-size: 0.8rem; color: var(--muted); text-align: center;">
                Veckobaserat: {{ balance.week_based_used }}d | Enskilda dagar: {{ balance.day_level_used }}d
            </div>
            {% endif %}
        </div>

        <!-- Projection Card (open years) -->
        {% if balance.projection %}
        <div class="card" style="margin-bottom: 16px; border: 1px solid var(--accent); border-left: 4px solid var(--accent);">
            <h3 style="margin-top: 0; font-size: 0.95rem;">Vid semesterbryt ({{ balance.year_end | date_format }})</h3>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 0.85rem;">
                <span style="color: var(--muted);">Kvar vid bryt:</span>
                <span style="font-weight: 600;">{{ balance.remaining_days }} dagar (projektion)</span>
                <span style="color: var(--muted);">Sparas:</span>
                <span style="font-weight: 600; color: var(--accent-2);">{{ balance.projection.days_to_save }} dagar &rarr; n&auml;sta &aring;r</span>
                {% if balance.projection.days_to_pay_out > 0 %}
                <span style="color: var(--muted);">Betalas ut:</span>
                <span style="font-weight: 600;">{{ balance.projection.days_to_pay_out }} dagar</span>
                <span style="color: var(--muted);">Utbetalning:</span>
                <span style="font-weight: 600; color: var(--accent-2);">{{ balance.projection.days_to_pay_out }} &times; {{ "%.0f"|format(balance.projection.payout_per_day) }} kr = {{ "{:,.0f}".format(balance.projection.payout_total).replace(",", " ") }} kr</span>
                {% endif %}
            </div>
            {% if balance.projection.days_to_pay_out > 0 %}
            <div style="margin-top: 8px; font-size: 0.65rem; color: var(--muted);">
                Semesterers&auml;ttning: 5,4% av l&ouml;n + 0,5% av r&ouml;rligt per dag (&sect;9.5)
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Closed Year Card (past years) -->
        {% if balance.closed %}
        <div class="card" style="margin-bottom: 16px; border-left: 4px solid var(--accent-2);">
            <h3 style="margin-top: 0; font-size: 0.95rem;">Semester&aring;ret st&auml;ngt</h3>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 0.85rem;">
                {% if balance.closed.saved > 0 %}
                <span style="color: var(--muted);">Sparade:</span>
                <span style="font-weight: 600; color: var(--accent-2);">{{ balance.closed.saved }} dagar &rarr; &ouml;verf&ouml;rda</span>
                {% endif %}
                {% if balance.closed.paid_out > 0 %}
                <span style="color: var(--muted);">Utbetalda:</span>
                <span style="font-weight: 600;">{{ balance.closed.paid_out }} dagar &rarr; {{ "{:,.0f}".format(balance.closed.payout_amount).replace(",", " ") }} kr</span>
                {% endif %}
                {% if balance.closed.saved == 0 and balance.closed.paid_out == 0 %}
                <span style="color: var(--muted);">Alla dagar uttagna.</span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Vacation Supplement Card -->
        {% if balance.pay %}
        <div class="card" style="margin-bottom: 16px;">
            <h3 style="margin-top: 0;">Semestertill&auml;gg</h3>
            <div style="font-size: 0.7rem; color: var(--muted); margin-bottom: 12px;">Handelns tj&auml;nstemannaavtal 2025&ndash;2027</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                <div style="text-align: center;">
                    <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 4px;">Fast/dag</div>
                    <div style="font-size: 1.2rem; font-weight: 700;">{{ "%.0f"|format(balance.pay.fixed_per_day) }} kr</div>
                    <div style="color: var(--muted); font-size: 0.7rem;">0,8% av m&aring;nadsl&ouml;n</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 4px;">R&ouml;rlig/dag</div>
                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent);">{{ "%.0f"|format(balance.pay.variable_per_day) }} kr</div>
                    <div style="color: var(--muted); font-size: 0.7rem;">0,5% av r&ouml;rliga</div>
                </div>
            </div>
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: var(--radius); margin-bottom: 12px;">
                <div style="color: var(--muted); font-size: 0.75rem; margin-bottom: 4px;">Tilll&auml;gg per semesterdag</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-2);">{{ "%.0f"|format(balance.pay.supplement_per_day) }} kr</div>
                <div style="color: var(--muted); font-size: 0.7rem; margin-top: 4px;">
                    Totalt f&ouml;r {{ balance.entitled_days }} dagar: {{ "{:,.0f}".format(balance.pay.supplement_total).replace(",", " ") }} kr
                </div>
            </div>
            <div style="font-size: 0.75rem; color: var(--muted);">
                <div style="margin-bottom: 4px;">R&ouml;rliga delar under intj&auml;nande&aring;ret ({{ balance.earning_year_start | date_format }} &mdash; {{ balance.earning_year_end | date_format }}):</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 12px;">
                    <span>OB/skifttill&auml;gg:</span>
                    <span style="text-align: right;">{{ "{:,.0f}".format(balance.pay.ob_total).replace(",", " ") }} kr</span>
                    <span>&Ouml;vertid:</span>
                    <span style="text-align: right;">{{ "{:,.0f}".format(balance.pay.ot_total).replace(",", " ") }} kr</span>
                    <span>Beredskap:</span>
                    <span style="text-align: right;">{{ "{:,.0f}".format(balance.pay.oncall_total).replace(",", " ") }} kr</span>
                </div>
                <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--table-border);">
                    <span>Summa r&ouml;rligt:</span>
                    <span style="float: right;">{{ "{:,.0f}".format(balance.pay.variable_total).replace(",", " ") }} kr</span>
                </div>
                <div>
                    <span>M&aring;nadsl&ouml;n:</span>
                    <span style="float: right;">{{ "{:,.0f}".format(balance.pay.monthly_salary).replace(",", " ") }} kr</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Week Selection Grid -->
        <div class="card" style="margin-bottom: 16px;">
            <h3 style="margin-top: 0;">Semesterveckor</h3>
            <p style="color: var(--muted); margin-bottom: 16px;">Klicka p&aring; veckor f&ouml;r att markera/avmarkera.</p>

            <form method="POST" action="/admin/vacation/{{ edit_user.id }}/weeks" id="vacation-form">
                <input type="hidden" name="year" value="{{ year }}">
                <input type="hidden" name="weeks" id="weeks-input" value="{{ vacation_weeks | join(',') }}">

                <div class="week-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; margin-bottom: 24px;">
                    {% for week in range(1, 53) %}
                        <button
                            type="button"
                            class="week-btn {% if week in vacation_weeks %}selected{% endif %}"
                            data-week="{{ week }}"
                            style="
                                padding: 12px 8px;
                                border-radius: var(--radius);
                                border: 1px solid var(--table-border);
                                background: {% if week in vacation_weeks %}var(--accent){% else %}var(--panel){% endif %};
                                color: {% if week in vacation_weeks %}var(--bg){% else %}var(--text){% endif %};
                                cursor: pointer;
                                font-weight: {% if week in vacation_weeks %}600{% else %}400{% endif %};
                                transition: all 0.15s;
                            "
                        >
                            v{{ week }}
                        </button>
                    {% endfor %}
                </div>

                <button type="submit" class="btn">Spara veckor</button>
            </form>
        </div>

        <!-- Day-Level Vacation Calendar -->
        <div class="card">
            <h3 style="margin-top: 0;">Enskilda semesterdagar</h3>
            <p style="color: var(--muted); margin-bottom: 16px;">Klicka p&aring; dagar f&ouml;r att markera/avmarkera semester.</p>

            <form method="POST" action="/admin/vacation/{{ edit_user.id }}/days/sync" id="days-form">
                <input type="hidden" name="year" value="{{ year }}">
                <input type="hidden" name="dates" id="dates-input"
                    value="{% for a in day_absences %}{{ a.date | date_format }}{% if not loop.last %},{% endif %}{% endfor %}">

                <div id="day-calendar" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;"></div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="day-count" style="color: var(--muted); font-size: 0.85rem;"></span>
                    <button type="submit" class="btn">Spara dagar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Right column: settings + summary -->
    <div class="col" style="min-width: 280px; flex: 1;">

        <!-- Vacation Settings -->
        <div class="card" style="margin-bottom: 16px;">
            <h3 style="margin-top: 0;">Inst&auml;llningar</h3>
            <form method="POST" action="/admin/vacation/{{ edit_user.id }}/settings">
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 6px; color: var(--muted); font-size: 0.85rem;">Anst&auml;llningsdatum</label>
                    <input type="date" name="employment_start_date"
                        value="{{ edit_user.employment_start_date | date_format }}"
                        style="width: 100%; padding: 8px 12px; border-radius: var(--radius); border: 1px solid var(--table-border); background: var(--panel); color: var(--text);">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 6px; color: var(--muted); font-size: 0.85rem;">Brytm&aring;nad</label>
                    <select name="vacation_year_start_month"
                        style="width: 100%; padding: 8px 12px; border-radius: var(--radius); border: 1px solid var(--table-border); background: var(--panel); color: var(--text);">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if edit_user.vacation_year_start_month == m %}selected{% endif %}>
                            {{ month_names[m-1] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; color: var(--muted); font-size: 0.85rem;">Semesterdagar/&aring;r</label>
                    <input type="number" name="vacation_days_per_year"
                        value="{{ edit_user.vacation_days_per_year }}" min="0" max="40"
                        style="width: 100%; padding: 8px 12px; border-radius: var(--radius); border: 1px solid var(--table-border); background: var(--panel); color: var(--text);">
                </div>
                <button type="submit" class="btn" style="width: 100%;">Spara inst&auml;llningar</button>
            </form>
        </div>

        <!-- Saved Days Editor -->
        <div class="card" style="margin-bottom: 16px;">
            <h3 style="margin-top: 0;">Sparade dagar</h3>
            <p style="color: var(--muted); font-size: 0.8rem; margin-bottom: 12px;">
                &Auml;ndra antal sparade dagar fr&aring;n tidigare semester&aring;r.
            </p>
            <form method="POST" action="/admin/vacation/{{ edit_user.id }}/saved">
                {% set saved_data = edit_user.vacation_saved or {} %}
                {% set has_entries = false %}
                {% for y in range(year - 5, year) %}
                    {% set yk = y|string %}
                    {% if yk in saved_data %}
                    {% set has_entries = true %}
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <label style="color: var(--muted); font-size: 0.85rem; min-width: 50px;">{{ y }}:</label>
                        <input type="number" name="saved_{{ y }}" min="0" max="25"
                            value="{{ saved_data[yk].saved }}"
                            style="width: 60px; padding: 6px 8px; border-radius: var(--radius); border: 1px solid var(--table-border); background: var(--panel); color: var(--text); text-align: center;">
                        <span style="color: var(--muted); font-size: 0.75rem;">dagar</span>
                    </div>
                    {% endif %}
                {% endfor %}
                {% if not has_entries %}
                <p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 8px;">Inga st&auml;ngda semester&aring;r &auml;nnu.</p>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <label style="color: var(--muted); font-size: 0.85rem; min-width: 50px;">{{ year - 1 }}:</label>
                    <input type="number" name="saved_{{ year - 1 }}" min="0" max="25" value="0"
                        style="width: 60px; padding: 6px 8px; border-radius: var(--radius); border: 1px solid var(--table-border); background: var(--panel); color: var(--text); text-align: center;">
                    <span style="color: var(--muted); font-size: 0.75rem;">dagar</span>
                </div>
                {% endif %}
                <button type="submit" class="btn" style="width: 100%; margin-top: 4px;">Spara</button>
            </form>
        </div>

        <!-- Week Summary -->
        <div class="card">
            <h3 style="margin-top: 0;">Valda veckor</h3>
            <div id="selected-summary">
                {% if vacation_weeks %}
                    <p><strong>{{ vacation_weeks | length }}</strong> veckor valda:</p>
                    <p style="color: var(--muted);">{{ vacation_weeks | join(', ') }}</p>
                {% else %}
                    <p style="color: var(--muted);">Inga semesterveckor valda f&ouml;r {{ year }}.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const weeksInput = document.getElementById('weeks-input');
    const buttons = document.querySelectorAll('.week-btn');
    const summary = document.getElementById('selected-summary');

    let selectedWeeks = weeksInput.value
        ? weeksInput.value.split(',').map(w => parseInt(w.trim())).filter(w => !isNaN(w))
        : [];

    function updateSummary() {
        selectedWeeks.sort((a, b) => a - b);
        weeksInput.value = selectedWeeks.join(',');

        if (selectedWeeks.length > 0) {
            summary.innerHTML = `
                <p><strong>${selectedWeeks.length}</strong> veckor valda:</p>
                <p style="color: var(--muted);">${selectedWeeks.join(', ')}</p>
            `;
        } else {
            summary.innerHTML = '<p style="color: var(--muted);">Inga semesterveckor valda.</p>';
        }
    }

    buttons.forEach(btn => {
        btn.addEventListener('click', function() {
            const week = parseInt(this.dataset.week);
            const index = selectedWeeks.indexOf(week);

            if (index > -1) {
                selectedWeeks.splice(index, 1);
                this.classList.remove('selected');
                this.style.background = 'var(--panel)';
                this.style.color = 'var(--text)';
                this.style.fontWeight = '400';
            } else {
                selectedWeeks.push(week);
                this.classList.add('selected');
                this.style.background = 'var(--accent)';
                this.style.color = 'var(--bg)';
                this.style.fontWeight = '600';
            }

            updateSummary();
        });
    });

    // --- Day-level calendar ---
    const datesInput = document.getElementById('dates-input');
    const calendarEl = document.getElementById('day-calendar');
    const dayCountEl = document.getElementById('day-count');
    const calYear = {{ year }};

    const monthNames = ['Januari','Februari','Mars','April','Maj','Juni',
                        'Juli','Augusti','September','Oktober','November','December'];
    const dayHeaders = ['M&aring;','Ti','On','To','Fr','L&ouml;','S&ouml;'];

    let selectedDates = new Set(
        datesInput.value ? datesInput.value.split(',').map(s => s.trim()).filter(Boolean) : []
    );

    function updateDayCount() {
        datesInput.value = Array.from(selectedDates).sort().join(',');
        dayCountEl.textContent = selectedDates.size + ' dag' + (selectedDates.size !== 1 ? 'ar' : '') + ' valda';
    }

    function renderCalendar() {
        calendarEl.innerHTML = '';
        for (let m = 0; m < 12; m++) {
            const monthDiv = document.createElement('div');
            monthDiv.style.cssText = 'background: var(--panel); border-radius: var(--radius); padding: 8px; border: 1px solid var(--table-border);';

            const title = document.createElement('div');
            title.style.cssText = 'text-align: center; font-weight: 600; font-size: 0.85rem; margin-bottom: 6px;';
            title.textContent = monthNames[m];
            monthDiv.appendChild(title);

            const grid = document.createElement('div');
            grid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 0.75rem;';

            // Day headers
            dayHeaders.forEach(dh => {
                const hdr = document.createElement('div');
                hdr.style.cssText = 'text-align: center; color: var(--muted); font-size: 0.65rem; padding: 2px 0;';
                hdr.innerHTML = dh;
                grid.appendChild(hdr);
            });

            // Find first day of month and how many days
            const firstDay = new Date(calYear, m, 1);
            const daysInMonth = new Date(calYear, m + 1, 0).getDate();
            // Monday=0 offset (JS getDay: 0=Sun, so convert)
            let startOffset = (firstDay.getDay() + 6) % 7;

            // Empty cells before first day
            for (let i = 0; i < startOffset; i++) {
                const empty = document.createElement('div');
                grid.appendChild(empty);
            }

            // Day cells
            for (let d = 1; d <= daysInMonth; d++) {
                const dt = new Date(calYear, m, d);
                const iso = calYear + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
                const dayOfWeek = (dt.getDay() + 6) % 7; // 0=Mon
                const isWeekend = dayOfWeek >= 5;

                const cell = document.createElement('div');
                cell.textContent = d;
                cell.dataset.date = iso;

                const isSelected = selectedDates.has(iso);
                cell.style.cssText = 'text-align: center; padding: 3px 1px; border-radius: 3px; cursor: pointer; transition: all 0.1s; user-select: none;'
                    + (isSelected ? 'background: var(--accent); color: var(--bg); font-weight: 600;'
                       : isWeekend ? 'color: var(--muted); opacity: 0.4;'
                       : 'color: var(--text);');

                cell.addEventListener('click', function() {
                    const date = this.dataset.date;
                    if (selectedDates.has(date)) {
                        selectedDates.delete(date);
                        const wd = (new Date(date).getDay() + 6) % 7;
                        this.style.background = 'transparent';
                        this.style.color = wd >= 5 ? 'var(--muted)' : 'var(--text)';
                        this.style.fontWeight = '400';
                        this.style.opacity = wd >= 5 ? '0.4' : '1';
                    } else {
                        selectedDates.add(date);
                        this.style.background = 'var(--accent)';
                        this.style.color = 'var(--bg)';
                        this.style.fontWeight = '600';
                        this.style.opacity = '1';
                    }
                    updateDayCount();
                });

                grid.appendChild(cell);
            }

            monthDiv.appendChild(grid);
            calendarEl.appendChild(monthDiv);
        }
        updateDayCount();
    }

    renderCalendar();
});
</script>

{% endblock %}
