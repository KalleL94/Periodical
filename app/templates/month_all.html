{# app/templates/month_all.html #}
{% extends "base.html" %}

{% block page_content %}

    {# Compute prev/next month + year here #}
    {% if month == 1 %}
        {% set prev_month = 12 %}
        {% set prev_year = year - 1 %}
    {% else %}
        {% set prev_month = month - 1 %}
        {% set prev_year = year %}
    {% endif %}

    {% if month == 12 %}
        {% set next_month = 1 %}
        {% set next_year = year + 1 %}
    {% else %}
        {% set next_month = month + 1 %}
        {% set next_year = year %}
    {% endif %}

    <div class="page-header">
        <div class="page-header-left">
            <a href="/month?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-primary">Previous month</a>
            <a href="/month" class="btn btn-primary">Today</a>
            <a href="/month?year={{ next_year }}&month={{ next_month }}" class="btn btn-primary">Next month</a>
        </div>

        <div class="page-header-right">
            {# Visa bara länk till egen month-sida, eller alla om admin #}
            {% if user and user.role.value == 'admin' %}
                {% for p in persons %}
                    <a href="/month/{{ p.person_id }}?year={{ year }}&month={{ month }}"
                       class="btn secondary">
                        {{ p.person_id }}
                    </a>
                {% endfor %}
            {% elif user %}
                <a href="/month/{{ user.id }}?year={{ year }}&month={{ month }}" class="btn secondary">Min månad</a>
            {% endif %}
        </div>
    </div>

<h2 class="page-title">Monthly schedule - {{ year }}-{{ "%02d"|format(month) }}</h2>


    {% set header_days = persons[0].days if persons and persons|length > 0 else [] %}

    <div class="month-grid">
        <table class="month-schedule table-sticky">
            <thead>
                {# Visa OB-totaler endast om admin #}
                {% if user and user.role.value == 'admin' %}
                <tr>
                    <th></th>
                    <th>Total OB</th>
                    {% for p in persons %}
                        {% set total_ob = (p.ob_pay.get('OB1',0) or 0) + (p.ob_pay.get('OB2',0) or 0)
                                          + (p.ob_pay.get('OB3',0) or 0) + (p.ob_pay.get('OB4',0) or 0)
                                          + (p.ob_pay.get('OB5',0) or 0) %}
                        <th>{{ "%.2f"|format(total_ob) }}</th>
                    {% endfor %}
                </tr>
                {% endif %}
                <tr>
                    <th class="w-sm">Day</th>
                    <th class="w-md">Date</th>
                    {% for p in persons %}
                        <th class="person-header">
                            {# Länka bara till egen sida eller om admin #}
                            {% if user and (user.role.value == 'admin' or user.rotation_person_id == p.person_id) %}
                                {# Om det är användarens egen position, länka till user.id, annars person_id #}
                                {% set link_id = user.id if user.rotation_person_id == p.person_id else p.person_id %}
                                <a href="/month/{{ link_id }}?year={{ year }}&month={{ month }}">
                                    {{ p.person_name }}<br>
                                    <small>(#{{ p.person_id }})</small>
                                </a>
                            {% else %}
                                {{ p.person_name }}<br>
                                <small>(#{{ p.person_id }})</small>
                            {% endif %}
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% set ndays = header_days|length %}
                {% for i in range(ndays) %}
                    {% set day = header_days[i] %}
                    <tr class="shift-row {% if today is defined and day.date == today %}today-row{% endif %}">
                        <td class="day-cell">{{ day.weekday_name }}</td>
                        <td class="date-cell">{{ day.date }}</td>
                        {% for p in persons %}
                            {% set d = p.days[i] %}
                            <td class="day-cell"
                                title="{{ d.date.isoformat() }}"
                                style="border-left:6px solid {% if d.shift %}{{ d.shift.color }}{% else %}transparent{% endif %}; padding-left:8px;">
                                {% if d.shift %}
                                    {# Länka till day-sida bara om admin eller egen #}
                                    {% if user and (user.role.value == 'admin' or user.rotation_person_id == p.person_id) %}
                                        {% set link_id = user.id if user.rotation_person_id == p.person_id else p.person_id %}
                                        <a href="/day/{{ link_id }}/{{ d.date.year }}/{{ d.date.month }}/{{ d.date.day }}"
                                           style="text-decoration:none;">
                                    {% endif %}
                                        {% if d.shift.code == 'SEM' %}
                                            <span class="badge badge-sem"
                                                  title="Semester"
                                                  style="background: {{ d.shift.color }}; color: {{ d.shift.color | contrast }};">
                                                SEM
                                            </span>
                                        {% elif d.shift.code == 'OT' %}
                                            <span class="badge"
                                                  {% if d.start and d.end %}title="Övertid: {{ d.start.strftime('%H:%M') }} - {{ d.end.strftime('%H:%M') }}"{% endif %}
                                                  style="background: {{ d.shift.color }}; color: {{ d.shift.color | contrast }};">
                                                OT
                                            </span>
                                        {% else %}
                                            <span class="badge"
                                                  style="background: {{ d.shift.color }}; color: {{ d.shift.color | contrast }};">
                                                {{ d.shift.code }}
                                            </span>
                                        {% endif %}
                                    {% if user and (user.role.value == 'admin' or user.rotation_person_id == p.person_id) %}
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <span class="badge badge-off">OFF</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% endblock %}
