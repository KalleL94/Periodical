{# app/templates/admin_user_edit.html #}
{% extends "base.html" %}

{% block page_content %}

<div class="page-header">
    <div class="page-header-left">
        <a href="/admin/users" class="btn secondary">‚Üê Tillbaka</a>
    </div>
</div>

<h2 class="page-title">Redigera: {{ edit_user.name }}</h2>

<div style="max-width: 500px;">
    <div class="card">
        {% if error %}
            <div style="background: rgba(255,100,100,0.2); border: 1px solid var(--danger); padding: 12px; border-radius: var(--radius); margin-bottom: 16px;">
                {{ error }}
            </div>
        {% endif %}
        
        <form method="POST" action="/admin/users/{{ edit_user.id }}">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">ID</label>
                <input type="text" value="{{ edit_user.id }}" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">Anv√§ndarnamn</label>
                <input type="text" value="{{ edit_user.username }}" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
                <small style="color: var(--muted);">Kan inte √§ndras</small>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="name" style="display: block; margin-bottom: 6px; color: var(--muted);">Namn</label>
                <input type="text" id="name" name="name" value="{{ edit_user.name }}" required style="width: 100%; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">Nuvarande m√•nadsl√∂n</label>
                <input type="text" value="{{ '{:,}'.format(edit_user.wage).replace(',', ' ') }} SEK" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
                <small style="color: var(--muted);">Hantera l√∂nehistorik l√§ngre ner p√• sidan</small>
            </div>

            <div style="margin-bottom: 16px;">
                <label for="tax_table" style="display: block; margin-bottom: 6px; color: var(--muted);">Skattetabell</label>
                <select id="tax_table" name="tax_table" style="width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text);">
                    {% for table in available_tax_tables %}
                    <option value="{{ table }}" {% if edit_user.tax_table == table %}selected{% endif %}>Tabell {{ table }}</option>
                    {% endfor %}
                </select>
                <small style="color: var(--muted);">Skattetabell enligt Skatteverket</small>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="role" style="display: block; margin-bottom: 6px; color: var(--muted);">Roll</label>
                <select id="role" name="role" style="width: 100%; box-sizing: border-box;">
                    <option value="user" {% if edit_user.role.value == 'user' %}selected{% endif %}>User</option>
                    <option value="admin" {% if edit_user.role.value == 'admin' %}selected{% endif %}>Admin</option>
                </select>
            </div>

            <div style="margin-bottom: 16px;">
                <label for="person_id" style="display: block; margin-bottom: 6px; color: var(--muted);">Rotationsposition (person_id)</label>
                <input type="number" id="person_id" name="person_id"
                       value="{{ edit_user.person_id if edit_user.person_id is not none else '' }}"
                       min="1" max="10"
                       placeholder="1-10 eller tomt"
                       style="width: 100%; box-sizing: border-box;">
                <small style="color: var(--muted);">Vilken position (1-10) anv√§ndaren har i rotationsschemat. S√§tts normalt via "Starta anst√§llning".</small>
            </div>

            <div style="margin-bottom: 24px;">
                <label for="new_password" style="display: block; margin-bottom: 6px; color: var(--muted);">Nytt l√∂senord</label>
                <input type="password" id="new_password" name="new_password" minlength="6" style="width: 100%; box-sizing: border-box;">
                <small style="color: var(--muted);">L√§mna tomt f√∂r att beh√•lla nuvarande l√∂senord</small>
            </div>
            
            <button type="submit" class="btn">Spara √§ndringar</button>
        </form>
    </div>
    
    <!-- Wage History -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">L√∂nehistorik</h3>

        {% if wage_history %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">L√∂n (SEK)</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Fr√•n datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Till datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Status</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">√Ötg√§rd</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in wage_history %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 8px; font-weight: 500;">{{ "{:,}".format(record.wage).replace(',', ' ') }} SEK</td>
                        <td style="padding: 8px;">{{ record.effective_from }}</td>
                        <td style="padding: 8px;">
                            {% if record.effective_to %}
                                {{ record.effective_to }}
                            {% else %}
                                <span style="color: var(--muted); font-style: italic;">p√•g√•ende</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if record.is_current %}
                                <span style="color: var(--success); font-weight: 500;">‚úì Aktuell</span>
                            {% else %}
                                <span style="color: var(--muted);">Historisk</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if wage_history | length > 1 %}
                                <form method="POST" action="/admin/users/{{ edit_user.id }}/delete-wage/{{ record.id }}" style="display: inline;" onsubmit="return confirm('√Ñr du s√§ker p√• att du vill ta bort denna l√∂nepost?');">
                                    <button type="submit" class="btn danger" style="padding: 4px 8px; font-size: 0.875rem;">Ta bort</button>
                                </form>
                            {% else %}
                                <span style="color: var(--muted); font-size: 0.875rem;">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: var(--muted);">Ingen l√∂nehistorik tillg√§nglig.</p>
        {% endif %}
    </div>

    <!-- Add New Wage -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">L√§gg till ny l√∂n</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            L√§gg till en ny l√∂n med ett effektivt datum. Tidigare l√∂n kommer automatiskt att avslutas dagen innan.
        </p>

        <form method="POST" action="/admin/users/{{ edit_user.id }}/add-wage">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label for="new_wage" style="display: block; margin-bottom: 6px; color: var(--muted);">Ny l√∂n (SEK)</label>
                    <input
                        type="number"
                        id="new_wage"
                        name="new_wage"
                        required
                        min="0"
                        step="500"
                        placeholder="t.ex. 35000"
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>

                <div>
                    <label for="effective_from" style="display: block; margin-bottom: 6px; color: var(--muted);">Fr√•n datum</label>
                    <input
                        type="date"
                        id="effective_from"
                        name="effective_from"
                        required
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>
            </div>

            <button type="submit" class="btn">L√§gg till l√∂n</button>
        </form>
    </div>

    <!-- Person History (Employment Periods) -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">Anst√§llningshistorik</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Visar vilka positioner (1-10) denna anv√§ndare har haft i rotationen och n√§r.
        </p>

        {% if person_history %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Position</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Namn</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Fr√•n datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Till datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Status</th>
                        <th style="text-align: center; padding: 8px; color: var(--muted); font-weight: 500;">Ta bort</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in person_history %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 8px; font-weight: 500;">{{ record.person_id }}</td>
                        <td style="padding: 8px;">{{ record.name }}</td>
                        <td style="padding: 8px;">{{ record.effective_from }}</td>
                        <td style="padding: 8px;">
                            {% if record.effective_to %}
                                {{ record.effective_to }}
                            {% else %}
                                <span style="color: var(--muted); font-style: italic;">p√•g√•ende</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if record.is_current %}
                                <span style="color: var(--success); font-weight: 500;">‚úì Aktiv</span>
                            {% else %}
                                <span style="color: var(--muted);">Historisk</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            <form method="POST" action="/admin/users/{{ edit_user.id }}/delete-employment/{{ record.id }}" style="display: inline;" onsubmit="return confirm('Ta bort anst√§llningsrecord f√∂r position {{ record.person_id }} ({{ record.effective_from }})?');">
                                <button type="submit" class="btn danger" style="padding: 4px 8px; font-size: 12px;">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: var(--muted);">Ingen anst√§llningshistorik tillg√§nglig.</p>
        {% endif %}
    </div>

    <!-- End Employment -->
    {% if person_history and person_history | selectattr('is_current') | list %}
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0; color: var(--danger);">Avsluta anst√§llning</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Avslutar anv√§ndarens nuvarande anst√§llning. Anv√§ndaren kan fortfarande logga in f√∂r att se historisk data, men kommer markeras som inaktiv.
        </p>

        {% for record in person_history %}
            {% if record.is_current %}
                <form method="POST" action="/admin/users/{{ edit_user.id }}/end-employment" onsubmit="return confirm('√Ñr du s√§ker p√• att du vill avsluta {{ edit_user.name }}s anst√§llning p√• position {{ record.person_id }}?');">
                    <input type="hidden" name="person_id" value="{{ record.person_id }}">
                    <div style="margin-bottom: 16px;">
                        <label for="end_date" style="display: block; margin-bottom: 6px; color: var(--muted);">Sista arbetsdag</label>
                        <input
                            type="date"
                            id="end_date"
                            name="end_date"
                            required
                            style="width: 100%; box-sizing: border-box;"
                        >
                    </div>
                    <button type="submit" class="btn danger">Avsluta anst√§llning p√• position {{ record.person_id }}</button>
                </form>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Start Employment (if inactive or no current employment) -->
    {% set has_current_employment = person_history and (person_history | selectattr('is_current') | list | length > 0) %}
    {% if edit_user.is_active == 0 or not has_current_employment %}
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0; color: var(--success);">Starta ny anst√§llning</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Aktivera anv√§ndaren och tilldela en ny position i rotationen.
        </p>

        <form method="POST" action="/admin/users/{{ edit_user.id }}/start-employment">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label for="person_id" style="display: block; margin-bottom: 6px; color: var(--muted);">Position (1-10)</label>
                    <input
                        type="number"
                        id="person_id"
                        name="person_id"
                        required
                        min="1"
                        max="10"
                        placeholder="t.ex. 6"
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>

                <div>
                    <label for="start_date" style="display: block; margin-bottom: 6px; color: var(--muted);">F√∂rsta arbetsdag</label>
                    <input
                        type="date"
                        id="start_date"
                        name="start_date"
                        required
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>
            </div>

            <button type="submit" class="btn">Starta anst√§llning</button>
        </form>
    </div>
    {% endif %}

    <!-- Semester info -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">Semester</h3>
        {% set vacation = edit_user.vacation or {} %}
        {% if vacation %}
            {% for year, weeks in vacation.items() %}
                {% if weeks %}
                    <p><strong>{{ year }}:</strong> vecka {{ weeks | join(', ') }}</p>
                {% endif %}
            {% endfor %}
            {% if not vacation.values() | select | list %}
                <p style="color: var(--muted);">Ingen semester registrerad.</p>
            {% endif %}
        {% else %}
            <p style="color: var(--muted);">Ingen semester registrerad.</p>
        {% endif %}
    </div>
</div>

{% endblock %}
