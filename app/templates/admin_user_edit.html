{# app/templates/admin_user_edit.html #}
{% extends "base.html" %}

{% block page_content %}

<div class="page-header">
    <div class="page-header-left">
        <a href="/admin/users" class="btn secondary">‚Üê Tillbaka</a>
    </div>
</div>

<h2 class="page-title">Redigera: {{ edit_user.name }}</h2>

<div style="max-width: 500px;">
    <div class="card">
        {% if error %}
            <div style="background: rgba(255,100,100,0.2); border: 1px solid var(--danger); padding: 12px; border-radius: var(--radius); margin-bottom: 16px;">
                {{ error }}
            </div>
        {% endif %}
        
        <form method="POST" action="/admin/users/{{ edit_user.id }}">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">ID</label>
                <input type="text" value="{{ edit_user.id }}" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">Anv√§ndarnamn</label>
                <input type="text" value="{{ edit_user.username }}" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
                <small style="color: var(--muted);">Kan inte √§ndras</small>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="name" style="display: block; margin-bottom: 6px; color: var(--muted);">Namn</label>
                <input type="text" id="name" name="name" value="{{ edit_user.name }}" required style="width: 100%; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">Nuvarande m√•nadsl√∂n</label>
                <input type="text" value="{{ '{:,}'.format(edit_user.wage).replace(',', ' ') }} SEK" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
                <small style="color: var(--muted);">Hantera l√∂nehistorik l√§ngre ner p√• sidan</small>
            </div>

            <div style="margin-bottom: 16px;">
                <label for="tax_table" style="display: block; margin-bottom: 6px; color: var(--muted);">Skattetabell</label>
                <select id="tax_table" name="tax_table" style="width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text);">
                    {% for table in available_tax_tables %}
                    <option value="{{ table }}" {% if edit_user.tax_table == table %}selected{% endif %}>Tabell {{ table }}</option>
                    {% endfor %}
                </select>
                <small style="color: var(--muted);">Skattetabell enligt Skatteverket</small>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="role" style="display: block; margin-bottom: 6px; color: var(--muted);">Roll</label>
                <select id="role" name="role" style="width: 100%; box-sizing: border-box;">
                    <option value="user" {% if edit_user.role.value == 'user' %}selected{% endif %}>User</option>
                    <option value="admin" {% if edit_user.role.value == 'admin' %}selected{% endif %}>Admin</option>
                </select>
            </div>

            <div style="margin-bottom: 16px;">
                <label for="person_id" style="display: block; margin-bottom: 6px; color: var(--muted);">Rotationsposition (person_id)</label>
                <input type="number" id="person_id" name="person_id"
                       value="{{ edit_user.person_id if edit_user.person_id is not none else '' }}"
                       min="1" max="10"
                       placeholder="1-10 eller tomt"
                       style="width: 100%; box-sizing: border-box;">
                <small style="color: var(--muted);">Vilken position (1-10) anv√§ndaren har i rotationsschemat. S√§tts normalt via "Starta anst√§llning".</small>
            </div>

            <div style="margin-bottom: 24px;">
                <label for="new_password" style="display: block; margin-bottom: 6px; color: var(--muted);">Nytt l√∂senord</label>
                <input type="password" id="new_password" name="new_password" minlength="6" style="width: 100%; box-sizing: border-box;">
                <small style="color: var(--muted);">L√§mna tomt f√∂r att beh√•lla nuvarande l√∂senord</small>
            </div>
            
            <button type="submit" class="btn">Spara √§ndringar</button>
        </form>
    </div>
    
    <!-- Wage History -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">L√∂nehistorik</h3>

        {% if wage_history %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">L√∂n (SEK)</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Fr√•n datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Till datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Status</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">√Ötg√§rd</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in wage_history %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 8px; font-weight: 500;">{{ "{:,}".format(record.wage).replace(',', ' ') }} SEK</td>
                        <td style="padding: 8px;">{{ record.effective_from }}</td>
                        <td style="padding: 8px;">
                            {% if record.effective_to %}
                                {{ record.effective_to }}
                            {% else %}
                                <span style="color: var(--muted); font-style: italic;">p√•g√•ende</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if record.is_current %}
                                <span style="color: var(--success); font-weight: 500;">‚úì Aktuell</span>
                            {% else %}
                                <span style="color: var(--muted);">Historisk</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if wage_history | length > 1 %}
                                <form method="POST" action="/admin/users/{{ edit_user.id }}/delete-wage/{{ record.id }}" style="display: inline;" onsubmit="return confirm('√Ñr du s√§ker p√• att du vill ta bort denna l√∂nepost?');">
                                    <button type="submit" class="btn danger" style="padding: 4px 8px; font-size: 0.875rem;">Ta bort</button>
                                </form>
                            {% else %}
                                <span style="color: var(--muted); font-size: 0.875rem;">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: var(--muted);">Ingen l√∂nehistorik tillg√§nglig.</p>
        {% endif %}
    </div>

    <!-- Add New Wage -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">L√§gg till ny l√∂n</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            L√§gg till en ny l√∂n med ett effektivt datum. Tidigare l√∂n kommer automatiskt att avslutas dagen innan.
        </p>

        <form method="POST" action="/admin/users/{{ edit_user.id }}/add-wage">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label for="new_wage" style="display: block; margin-bottom: 6px; color: var(--muted);">Ny l√∂n (SEK)</label>
                    <input
                        type="number"
                        id="new_wage"
                        name="new_wage"
                        required
                        min="0"
                        step="500"
                        placeholder="t.ex. 35000"
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>

                <div>
                    <label for="effective_from" style="display: block; margin-bottom: 6px; color: var(--muted);">Fr√•n datum</label>
                    <input
                        type="date"
                        id="effective_from"
                        name="effective_from"
                        required
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>
            </div>

            <button type="submit" class="btn">L√§gg till l√∂n</button>
        </form>
    </div>

    <!-- Person History (Employment Periods) -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">Anst√§llningshistorik</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Visar vilka positioner (1-10) denna anv√§ndare har haft i rotationen och n√§r.
        </p>

        {% if person_history %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Position</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Namn</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Fr√•n datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Till datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Status</th>
                        <th style="text-align: center; padding: 8px; color: var(--muted); font-weight: 500;">Ta bort</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in person_history %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 8px; font-weight: 500;">{{ record.person_id }}</td>
                        <td style="padding: 8px;">{{ record.name }}</td>
                        <td style="padding: 8px;">{{ record.effective_from }}</td>
                        <td style="padding: 8px;">
                            {% if record.effective_to %}
                                {{ record.effective_to }}
                            {% else %}
                                <span style="color: var(--muted); font-style: italic;">p√•g√•ende</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if record.is_current %}
                                <span style="color: var(--success); font-weight: 500;">‚úì Aktiv</span>
                            {% else %}
                                <span style="color: var(--muted);">Historisk</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            <form method="POST" action="/admin/users/{{ edit_user.id }}/delete-employment/{{ record.id }}" style="display: inline;" onsubmit="return confirm('Ta bort anst√§llningsrecord f√∂r position {{ record.person_id }} ({{ record.effective_from }})?');">
                                <button type="submit" class="btn danger" style="padding: 4px 8px; font-size: 12px;">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: var(--muted);">Ingen anst√§llningshistorik tillg√§nglig.</p>
        {% endif %}
    </div>

    <!-- End Employment -->
    {% if person_history and person_history | selectattr('is_current') | list %}
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0; color: var(--danger);">Avsluta anst√§llning</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Avslutar anv√§ndarens nuvarande anst√§llning. Anv√§ndaren kan fortfarande logga in f√∂r att se historisk data, men kommer markeras som inaktiv.
        </p>

        {% for record in person_history %}
            {% if record.is_current %}
                <form method="POST" action="/admin/users/{{ edit_user.id }}/end-employment" onsubmit="return confirm('√Ñr du s√§ker p√• att du vill avsluta {{ edit_user.name }}s anst√§llning p√• position {{ record.person_id }}?');">
                    <input type="hidden" name="person_id" value="{{ record.person_id }}">
                    <div style="margin-bottom: 16px;">
                        <label for="end_date" style="display: block; margin-bottom: 6px; color: var(--muted);">Sista arbetsdag</label>
                        <input
                            type="date"
                            id="end_date"
                            name="end_date"
                            required
                            style="width: 100%; box-sizing: border-box;"
                        >
                    </div>
                    <button type="submit" class="btn danger">Avsluta anst√§llning p√• position {{ record.person_id }}</button>
                </form>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Start Employment (if inactive or no current employment) -->
    {% set has_current_employment = person_history and (person_history | selectattr('is_current') | list | length > 0) %}
    {% if edit_user.is_active == 0 or not has_current_employment %}
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0; color: var(--success);">Starta ny anst√§llning</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Aktivera anv√§ndaren och tilldela en ny position i rotationen.
        </p>

        <form method="POST" action="/admin/users/{{ edit_user.id }}/start-employment">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label for="person_id" style="display: block; margin-bottom: 6px; color: var(--muted);">Position (1-10)</label>
                    <input
                        type="number"
                        id="person_id"
                        name="person_id"
                        required
                        min="1"
                        max="10"
                        placeholder="t.ex. 6"
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>

                <div>
                    <label for="start_date" style="display: block; margin-bottom: 6px; color: var(--muted);">F√∂rsta arbetsdag</label>
                    <input
                        type="date"
                        id="start_date"
                        name="start_date"
                        required
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>
            </div>

            <button type="submit" class="btn">Starta anst√§llning</button>
        </form>
    </div>
    {% endif %}

    <!-- Semester -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">Semester</h3>

        {% if vacation_balance %}
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
            <div style="text-align: center;">
                <div style="color: var(--muted); font-size: 0.8rem; margin-bottom: 4px;">Tilldelade</div>
                <div style="font-size: 1.3rem; font-weight: 700;">{{ vacation_balance.entitled_days }}</div>
            </div>
            <div style="text-align: center;">
                <div style="color: var(--muted); font-size: 0.8rem; margin-bottom: 4px;">Uttagna</div>
                <div style="font-size: 1.3rem; font-weight: 700;">{{ vacation_balance.used_days }}</div>
            </div>
            <div style="text-align: center;">
                <div style="color: var(--muted); font-size: 0.8rem; margin-bottom: 4px;">Kvar</div>
                <div style="font-size: 1.3rem; font-weight: 700; color: {% if vacation_balance.remaining_days > 5 %}var(--accent-2){% elif vacation_balance.remaining_days > 0 %}var(--warning){% else %}var(--danger){% endif %};">
                    {{ vacation_balance.remaining_days }}
                </div>
            </div>
        </div>
        <div style="font-size: 0.8rem; color: var(--muted); margin-bottom: 12px;">
            Semester&aring;r: {{ vacation_balance.year_start | date_format }} &mdash; {{ vacation_balance.year_end | date_format }}
            {% if vacation_balance.is_first_year %}<span style="color: var(--warning);"> (proportionellt)</span>{% endif %}
        </div>
        {% endif %}

        {% set vacation = edit_user.vacation or {} %}
        {% if vacation %}
            {% for year, weeks in vacation.items() %}
                {% if weeks %}
                    <p style="font-size: 0.85rem;"><strong>{{ year }}:</strong> v{{ weeks | join(', v') }}</p>
                {% endif %}
            {% endfor %}
        {% endif %}

        <a href="/admin/vacation/{{ edit_user.id }}" class="btn secondary" style="margin-top: 8px;">
            Hantera semester
        </a>
    </div>

    <!-- Ers√§ttningssatser -->
    {% set rates_form_action = "/admin/users/" ~ edit_user.id ~ "/update-rates" %}
    {% set rates_delete_prefix = "/admin/users/" ~ edit_user.id ~ "/delete-rate/" %}
    {% include "rates_form.html" with context %}

    <!-- √ñvertag -->
    <div class="card" style="margin-top: 16px;">
        <h3>&#214;vertag</h3>

        {% if edit_transition %}
        <p class="form-hint">
            &#214;vertagsdatum: <strong>{{ edit_transition.transition_date }}</strong>,
            {{ "Sl&#228;pande" if edit_transition.consultant_salary_type.value == "trailing" else "Innest&#229;ende" }} konsultl&#246;n
        </p>
        {% if admin_auto_variable_avg is not none %}
        <div class="auto-hint">
            Auto-ber&#228;knad r&#246;rlig genomsnittsl&#246;n: <strong>{{ "%.2f"|format(admin_auto_variable_avg) }} kr/dag</strong>
        </div>
        {% endif %}
        {% else %}
        <p class="form-hint">Inget &#246;vertag konfigurerat.</p>
        {% endif %}

        <form method="POST" action="/admin/users/{{ edit_user.id }}/transition">

            <div class="form-group">
                <label for="adm_transition_date" class="form-label">&#214;vertagsdatum</label>
                <input type="date" id="adm_transition_date" name="transition_date" class="form-input"
                       value="{{ edit_transition.transition_date.isoformat() if edit_transition else '' }}" required>
            </div>

            <div class="form-group">
                <label for="adm_salary_type" class="form-label">Konsultl&#246;netyp</label>
                <select id="adm_salary_type" name="consultant_salary_type" class="form-input">
                    {% for value, label in salary_types %}
                    <option value="{{ value }}"
                        {% if edit_transition and edit_transition.consultant_salary_type.value == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Intj&#228;nade semesterdagar (fr&#229;n konsultanst&#228;llningen)</label>
                {% if admin_auto_vacation_days is not none %}
                <div class="auto-hint">
                    Auto-ber&#228;knat: <strong>{{ admin_auto_vacation_days }} dagar</strong>
                    <span class="form-hint">Pro-ratat fr&#229;n anst&#228;llningsdagen inom intj&#228;nande&#229;ret</span>
                </div>
                {% elif edit_transition %}
                <div class="auto-hint auto-hint--missing">
                    Kan inte ber&#228;knas, saknar anst&#228;llningsdatum. Sparat: {{ edit_transition.consultant_vacation_days }} dagar.
                </div>
                {% endif %}
                <label class="form-label" style="margin-top: 0.4rem;">
                    Manuell override (tomt = anv&#228;nd auto)
                </label>
                <input type="number" id="adm_vacation_days" name="consultant_vacation_days" class="form-input"
                       value="{{ edit_transition.consultant_vacation_days if edit_transition and edit_transition.consultant_vacation_days != admin_auto_vacation_days else '' }}"
                       min="0" step="0.5"
                       placeholder="{{ admin_auto_vacation_days if admin_auto_vacation_days is not none else '' }}">
            </div>

            <div class="form-group">
                <label for="adm_supplement_pct" class="form-label">Semestertill&#228;ggsprocent (semesterlagen)</label>
                <input type="number" id="adm_supplement_pct" name="consultant_supplement_pct" class="form-input"
                       value="{{ edit_transition.consultant_supplement_pct if edit_transition else 0.0043 }}"
                       min="0" max="0.99" step="0.0001" required>
            </div>

            <div class="form-group">
                <label for="adm_variable_override" class="form-label">R&#246;rlig genomsnittsl&#246;n override kr/dag (tomt = auto)</label>
                <input type="number" id="adm_variable_override" name="variable_avg_daily_override" class="form-input"
                       value="{{ edit_transition.variable_avg_daily_override if edit_transition and edit_transition.variable_avg_daily_override is not none else '' }}"
                       min="0" step="0.01"
                       placeholder="{{ '%.2f'|format(admin_auto_variable_avg) if admin_auto_variable_avg else '' }}">
            </div>

            <div class="form-group">
                <label for="adm_earning_start" class="form-label">Intj&#228;nande&#229;r start (tomt = auto)</label>
                <input type="date" id="adm_earning_start" name="earning_year_start" class="form-input"
                       value="{{ edit_transition.earning_year_start.isoformat() if edit_transition and edit_transition.earning_year_start else '' }}">
            </div>

            <div class="form-group">
                <label for="adm_earning_end" class="form-label">Intj&#228;nande&#229;r slut (tomt = auto)</label>
                <input type="date" id="adm_earning_end" name="earning_year_end" class="form-input"
                       value="{{ edit_transition.earning_year_end.isoformat() if edit_transition and edit_transition.earning_year_end else '' }}">
            </div>

            <div class="form-group">
                <label for="adm_notes" class="form-label">Anteckningar</label>
                <textarea id="adm_notes" name="notes" rows="2" class="form-input"
                          style="padding: 0.5rem; resize: vertical;">{{ edit_transition.notes if edit_transition and edit_transition.notes else '' }}</textarea>
            </div>

            <hr class="form-section-divider">
            <p class="form-section-title">Vid sparande (eng&#229;ngs&#229;tg&#228;rder)</p>

            <div class="form-group">
                <label for="adm_new_direct_salary" class="form-label">S&#228;tt ny direktl&#246;n fr&#229;n &#246;vertagsdatum (kr/m&#229;nad, tomt = ingen &#228;ndring)</label>
                <input type="number" id="adm_new_direct_salary" name="new_direct_salary" class="form-input"
                       min="1" step="1" placeholder="t.ex. 32000">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" name="reset_rates_to_default" value="on">
                    &#197;terg&#229; till standard OB/OT/beredskap-satser fr&#229;n &#246;vertagsdatum
                </label>
            </div>

            <button type="submit" class="btn btn-primary">Spara &#246;vertag</button>
        </form>

        {% if edit_transition %}
        <hr class="form-section-divider">
        <form method="POST" action="/admin/users/{{ edit_user.id }}/transition/delete">
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" name="cleanup_wage" value="on" checked>
                    Ta &#228;ven bort l&#246;nepost fr&#229;n &#246;vertagsdatumet ({{ edit_transition.transition_date }})
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" name="cleanup_rates" value="on" checked>
                    Ta &#228;ven bort satspost fr&#229;n &#246;vertagsdatumet ({{ edit_transition.transition_date }})
                </label>
            </div>
            <button type="submit" class="btn btn-danger">Ta bort inst&#228;llningar</button>
        </form>
        {% endif %}
    </div>
</div>

{% endblock %}
