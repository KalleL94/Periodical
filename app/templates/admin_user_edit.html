{# app/templates/admin_user_edit.html #}
{% extends "base.html" %}

{% block page_content %}

<div class="page-header">
    <div class="page-header-left">
        <a href="/admin/users" class="btn secondary">← Tillbaka</a>
    </div>
</div>

<h2 class="page-title">Redigera: {{ edit_user.name }}</h2>

<div style="max-width: 500px;">
    <div class="card">
        {% if error %}
            <div style="background: rgba(255,100,100,0.2); border: 1px solid var(--danger); padding: 12px; border-radius: var(--radius); margin-bottom: 16px;">
                {{ error }}
            </div>
        {% endif %}
        
        <form method="POST" action="/admin/users/{{ edit_user.id }}">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">ID</label>
                <input type="text" value="{{ edit_user.id }}" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">Användarnamn</label>
                <input type="text" value="{{ edit_user.username }}" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
                <small style="color: var(--muted);">Kan inte ändras</small>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="name" style="display: block; margin-bottom: 6px; color: var(--muted);">Namn</label>
                <input type="text" id="name" name="name" value="{{ edit_user.name }}" required style="width: 100%; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--muted);">Nuvarande månadslön</label>
                <input type="text" value="{{ '{:,}'.format(edit_user.wage).replace(',', ' ') }} SEK" disabled style="width: 100%; box-sizing: border-box; opacity: 0.6;">
                <small style="color: var(--muted);">Hantera lönehistorik längre ner på sidan</small>
            </div>

            <div style="margin-bottom: 16px;">
                <label for="tax_table" style="display: block; margin-bottom: 6px; color: var(--muted);">Skattetabell</label>
                <select id="tax_table" name="tax_table" style="width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text);">
                    {% for table in available_tax_tables %}
                    <option value="{{ table }}" {% if edit_user.tax_table == table %}selected{% endif %}>Tabell {{ table }}</option>
                    {% endfor %}
                </select>
                <small style="color: var(--muted);">Skattetabell enligt Skatteverket</small>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="role" style="display: block; margin-bottom: 6px; color: var(--muted);">Roll</label>
                <select id="role" name="role" style="width: 100%; box-sizing: border-box;">
                    <option value="user" {% if edit_user.role.value == 'user' %}selected{% endif %}>User</option>
                    <option value="admin" {% if edit_user.role.value == 'admin' %}selected{% endif %}>Admin</option>
                </select>
            </div>
            
            <div style="margin-bottom: 24px;">
                <label for="new_password" style="display: block; margin-bottom: 6px; color: var(--muted);">Nytt lösenord</label>
                <input type="password" id="new_password" name="new_password" minlength="6" style="width: 100%; box-sizing: border-box;">
                <small style="color: var(--muted);">Lämna tomt för att behålla nuvarande lösenord</small>
            </div>
            
            <button type="submit" class="btn">Spara ändringar</button>
        </form>
    </div>
    
    <!-- Wage History -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">Lönehistorik</h3>

        {% if wage_history %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Lön (SEK)</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Från datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Till datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Status</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Åtgärd</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in wage_history %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 8px; font-weight: 500;">{{ "{:,}".format(record.wage).replace(',', ' ') }} SEK</td>
                        <td style="padding: 8px;">{{ record.effective_from }}</td>
                        <td style="padding: 8px;">
                            {% if record.effective_to %}
                                {{ record.effective_to }}
                            {% else %}
                                <span style="color: var(--muted); font-style: italic;">pågående</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if record.is_current %}
                                <span style="color: var(--success); font-weight: 500;">✓ Aktuell</span>
                            {% else %}
                                <span style="color: var(--muted);">Historisk</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if wage_history | length > 1 %}
                                <form method="POST" action="/admin/users/{{ edit_user.id }}/delete-wage/{{ record.id }}" style="display: inline;" onsubmit="return confirm('Är du säker på att du vill ta bort denna lönepost?');">
                                    <button type="submit" class="btn danger" style="padding: 4px 8px; font-size: 0.875rem;">Ta bort</button>
                                </form>
                            {% else %}
                                <span style="color: var(--muted); font-size: 0.875rem;">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: var(--muted);">Ingen lönehistorik tillgänglig.</p>
        {% endif %}
    </div>

    <!-- Add New Wage -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">Lägg till ny lön</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Lägg till en ny lön med ett effektivt datum. Tidigare lön kommer automatiskt att avslutas dagen innan.
        </p>

        <form method="POST" action="/admin/users/{{ edit_user.id }}/add-wage">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label for="new_wage" style="display: block; margin-bottom: 6px; color: var(--muted);">Ny lön (SEK)</label>
                    <input
                        type="number"
                        id="new_wage"
                        name="new_wage"
                        required
                        min="0"
                        step="500"
                        placeholder="t.ex. 35000"
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>

                <div>
                    <label for="effective_from" style="display: block; margin-bottom: 6px; color: var(--muted);">Från datum</label>
                    <input
                        type="date"
                        id="effective_from"
                        name="effective_from"
                        required
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>
            </div>

            <button type="submit" class="btn">Lägg till lön</button>
        </form>
    </div>

    <!-- Person History (Employment Periods) -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">Anställningshistorik</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Visar vilka positioner (1-10) denna användare har haft i rotationen och när.
        </p>

        {% if person_history %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Position</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Namn</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Från datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Till datum</th>
                        <th style="text-align: left; padding: 8px; color: var(--muted); font-weight: 500;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in person_history %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 8px; font-weight: 500;">{{ record.person_id }}</td>
                        <td style="padding: 8px;">{{ record.name }}</td>
                        <td style="padding: 8px;">{{ record.effective_from }}</td>
                        <td style="padding: 8px;">
                            {% if record.effective_to %}
                                {{ record.effective_to }}
                            {% else %}
                                <span style="color: var(--muted); font-style: italic;">pågående</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if record.is_current %}
                                <span style="color: var(--success); font-weight: 500;">✓ Aktiv</span>
                            {% else %}
                                <span style="color: var(--muted);">Historisk</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: var(--muted);">Ingen anställningshistorik tillgänglig.</p>
        {% endif %}
    </div>

    <!-- End Employment -->
    {% if person_history and person_history | selectattr('is_current') | list %}
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0; color: var(--danger);">Avsluta anställning</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Avslutar användarens nuvarande anställning. Användaren kan fortfarande logga in för att se historisk data, men kommer markeras som inaktiv.
        </p>

        {% for record in person_history %}
            {% if record.is_current %}
                <form method="POST" action="/admin/users/{{ edit_user.id }}/end-employment" onsubmit="return confirm('Är du säker på att du vill avsluta {{ edit_user.name }}s anställning på position {{ record.person_id }}?');">
                    <input type="hidden" name="person_id" value="{{ record.person_id }}">
                    <div style="margin-bottom: 16px;">
                        <label for="end_date" style="display: block; margin-bottom: 6px; color: var(--muted);">Sista arbetsdag</label>
                        <input
                            type="date"
                            id="end_date"
                            name="end_date"
                            required
                            style="width: 100%; box-sizing: border-box;"
                        >
                    </div>
                    <button type="submit" class="btn danger">Avsluta anställning på position {{ record.person_id }}</button>
                </form>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Start Employment (if inactive) -->
    {% if edit_user.is_active == 0 %}
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0; color: var(--success);">Starta ny anställning</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
            Aktivera användaren och tilldela en ny position i rotationen.
        </p>

        <form method="POST" action="/admin/users/{{ edit_user.id }}/start-employment">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label for="person_id" style="display: block; margin-bottom: 6px; color: var(--muted);">Position (1-10)</label>
                    <input
                        type="number"
                        id="person_id"
                        name="person_id"
                        required
                        min="1"
                        max="10"
                        placeholder="t.ex. 6"
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>

                <div>
                    <label for="start_date" style="display: block; margin-bottom: 6px; color: var(--muted);">Första arbetsdag</label>
                    <input
                        type="date"
                        id="start_date"
                        name="start_date"
                        required
                        style="width: 100%; box-sizing: border-box;"
                    >
                </div>
            </div>

            <button type="submit" class="btn">Starta anställning</button>
        </form>
    </div>
    {% endif %}

    <!-- Semester info -->
    <div class="card" style="margin-top: 16px;">
        <h3 style="margin-top: 0;">Semester</h3>
        {% set vacation = edit_user.vacation or {} %}
        {% if vacation %}
            {% for year, weeks in vacation.items() %}
                {% if weeks %}
                    <p><strong>{{ year }}:</strong> vecka {{ weeks | join(', ') }}</p>
                {% endif %}
            {% endfor %}
            {% if not vacation.values() | select | list %}
                <p style="color: var(--muted);">Ingen semester registrerad.</p>
            {% endif %}
        {% else %}
            <p style="color: var(--muted);">Ingen semester registrerad.</p>
        {% endif %}
    </div>
</div>

{% endblock %}
