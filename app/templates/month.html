{# app/templates/month.html #}
{% extends "base.html" %}

{% block page_content %}

    {# Compute prev/next month + year here in the template #}
    {% if month == 1 %}
        {% set prev_month = 12 %}
        {% set prev_year = year - 1 %}
    {% else %}
        {% set prev_month = month - 1 %}
        {% set prev_year = year %}
    {% endif %}

    {% if month == 12 %}
        {% set next_month = 1 %}
        {% set next_year = year + 1 %}
    {% else %}
        {% set next_month = month + 1 %}
        {% set next_year = year %}
    {% endif %}

    <div class="page-header">
        <div class="page-header-left">
            <a href="/month/{{ person_id }}?year={{ prev_year }}&month={{ prev_month }}"
               class="btn btn-primary">Previous month</a>

            <a href="/month/{{ person_id }}" class="btn btn-primary">Today</a>

            <a href="/month/{{ person_id }}?year={{ next_year }}&month={{ next_month }}"
               class="btn btn-primary">Next month</a>
        </div>

        <div class="page-header-right">
            <a href="/month/{{ person_id - 1 if person_id != 1 else 10 }}?year={{ year }}&month={{ month }}" class="btn secondary">&lt-</a>
            <a href="/month?year={{ year }}&month={{ month }}" class="btn secondary">All</a>
            <a href="/month/{{ person_id + 1 if person_id != 10 else 1 }}?year={{ year }}&month={{ month }}" class="btn secondary">-&gt</a>
        </div>
    </div>

<h2 class="page-title">Month {{ month }} {{ year }} - {{ person_name }}</h2>


    {# Summary row #}
    <table class="summary">
        <thead>
            <tr>
                <th>Net salary</th>
                <th>Gross salary</th>
                <th>Number of shifts</th>
                <th>Total hours</th>
                <th>Total OB pay</th>
                <th>Evening (OB1)</th>
                <th>Night (OB2)</th>
                <th>Weekend (OB3+OB4)</th>
                <th>Holiday (OB5)</th>
            </tr>
        </thead>
        <tbody>
            {% set total_ob = days.ob_pay.get('OB1',0) + days.ob_pay.get('OB2',0)
                              + days.ob_pay.get('OB3',0) + days.ob_pay.get('OB4',0)
                              + days.ob_pay.get('OB5',0) %}
            <tr>
                <td>{{ "%.0f"|format(days.netto_pay) }}</td>
                <td>{{ "%.0f"|format(days.brutto_pay) }}</td>
                <td>{{ days.num_shifts }}</td>
                <td>{{ "%.2f"|format(days.total_hours) }}</td>
                <td>{{ "%.2f"|format(total_ob) }}</td>
                <td>{{ "%.2f"|format(days.ob_hours.get('OB1',0)) }}</td>
                <td>{{ "%.2f"|format(days.ob_hours.get('OB2',0)) }}</td>
                <td>{{ "%.2f"|format(days.ob_hours.get('OB3',0) + days.ob_hours.get('OB4',0)) }}</td>
                <td>{{ "%.2f"|format(days.ob_hours.get('OB5',0)) }}</td>
            </tr>
        </tbody>
    </table>

    {# Day by day #}
    <table class="month-schedule table-sticky">
        <thead>
            <tr>
                <th>Day</th>
                <th>Date</th>
                <th>Rotation week</th>
                <th>Shift</th>
                <th>Time</th>
                <th>OB pay</th>
                <th>Evening (OB1)</th>
                <th>Night (OB2)</th>
                <th>Weekend (OB3+OB4)</th>
                <th>Holiday (OB5)</th>
            </tr>
        </thead>
        <tbody>
            {% for d in days.days %}
                <tr class="shift-row {% if today is defined and d.date == today %}today-row{% endif %}"
                    style="border-left:6px solid {% if d.shift %}{{ d.shift.color }}{% else %}transparent{% endif %};">
                    <td>{{ d.weekday_name }}</td>
                    <td>
                        <a href="/day/{{ person_id }}/{{ d.date.year }}/{{ d.date.month }}/{{ d.date.day }}">
                            {{ d.date }}
                        </a>
                    </td>
                    <td>{{ d.rotation_week }}</td>
                    <td>
                        {% if d.shift %}
                            <span class="badge"
                                  style="background: {{ d.shift.color }}; color: {{ d.shift.color | contrast }};">
                                {{ d.shift.code }}
                            </span>
                        {% else %}
                            <span class="badge badge-off">OFF</span>
                        {% endif %}
                    </td>
                    {% if d.shift and d.shift.start_time is not none %}
                        {% set day_ob = d.ob_pay.get('OB1',0) + d.ob_pay.get('OB2',0)
                                        + d.ob_pay.get('OB3',0) + d.ob_pay.get('OB4',0)
                                        + d.ob_pay.get('OB5',0) %}
                        <td>{{ d.shift.start_time }} to {{ d.shift.end_time }}</td>
                        <td>{{ "%.2f"|format(day_ob) }}</td>
                        <td>{{ "%.2f"|format(d.ob_hours.get('OB1',0)) }}</td>
                        <td>{{ "%.2f"|format(d.ob_hours.get('OB2',0)) }}</td>
                        <td>{{ "%.2f"|format(d.ob_hours.get('OB3',0) + d.ob_hours.get('OB4',0)) }}</td>
                        <td>{{ "%.2f"|format(d.ob_hours.get('OB5',0)) }}</td>
                    {% else %}
                        <td>No shift</td>
                        <td>0</td><td>0</td><td>0</td><td>0</td>
                    {% endif %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

{{ super() }}

{% endblock %}
