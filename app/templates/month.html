{# app/templates/month.html #}
{% extends "base.html" %}

{% block page_content %}

    {# Compute prev/next month + year here in the template #}
    {% if month == 1 %}
        {% set prev_month = 12 %}
        {% set prev_year = year - 1 %}
    {% else %}
        {% set prev_month = month - 1 %}
        {% set prev_year = year %}
    {% endif %}

    {% if month == 12 %}
        {% set next_month = 1 %}
        {% set next_year = year + 1 %}
    {% else %}
        {% set next_month = month + 1 %}
        {% set next_year = year %}
    {% endif %}

    <div class="page-header">
        <div class="page-header-left">
            <a href="/month/{{ person_id }}?year={{ prev_year }}&month={{ prev_month }}"
               class="btn btn-primary">Previous month</a>

            <a href="/month/{{ person_id }}" class="btn btn-primary">Today</a>

            <a href="/month/{{ person_id }}?year={{ next_year }}&month={{ next_month }}"
               class="btn btn-primary">Next month</a>
        </div>

        <div class="page-header-right">
            {# Navigering mellan personer - endast för admin #}
            {% if user and user.role.value == 'admin' %}
                <a href="/month/{{ person_id - 1 if person_id != 1 else max_persons }}?year={{ year }}&month={{ month }}" class="btn secondary">&lt-</a>
            {% endif %}
            <a href="/month?year={{ year }}&month={{ month }}" class="btn secondary">All</a>
            {% if user and user.role.value == 'admin' %}
                <a href="/month/{{ person_id + 1 if person_id != max_persons else 1 }}?year={{ year }}&month={{ month }}" class="btn secondary">-&gt</a>
            {% endif %}
        </div>
    </div>

<h2 class="page-title">Month {{ month }} {{ year }} - {{ person_name }}</h2>


    {# Summary row - visa bara lönedata om show_salary #}
    <table class="summary">
        {% if show_salary %}
        <thead>
            <tr>
                <th>Net salary</th>
                <th>Gross salary</th>
                <th>Number of shifts</th>
                <th>Total hours</th>
                <th>Total OB pay</th>
                <th>Evening (OB1/150?)</th>
                <th>Night (OB2/151)</th>
                <th>Weekend (OB3+OB4/152)</th>
                <th>Holiday (OB5/153)</th>
                <th>On-call hours</th>
                <th>On-call pay</th>
                <th>OT pay</th>
            </tr>
        </thead>
        {% endif %}
        <tbody>
            {% set total_ob = (days.ob_pay.get('OB1',0) or 0) + (days.ob_pay.get('OB2',0) or 0)
                              + (days.ob_pay.get('OB3',0) or 0) + (days.ob_pay.get('OB4',0) or 0)
                              + (days.ob_pay.get('OB5',0) or 0) %}
            <tr>
                {% if show_salary %}
                <td data-label="Netto">{{ "%.0f"|format(days.netto_pay or 0) }}</td>
                <td data-label="Brutto">{{ "%.0f"|format(days.brutto_pay or 0) }}</td>
                {% endif %}
                <td data-label="Antal pass">{{ days.num_shifts }}</td>
                <td data-label="Timmar">{{ "%.2f"|format(days.total_hours or 0) }}</td>
                {% if show_salary %}
                <td data-label="Total OB">{{ "%.2f"|format(total_ob) }}</td>
                <td data-label="OB1 Kväll">{{ "%.2f"|format(days.ob_hours.get('OB1',0) or 0) }}</td>
                <td data-label="OB2 Natt">{{ "%.2f"|format(days.ob_hours.get('OB2',0) or 0) }}</td>
                <td data-label="OB3+4 Helg">{{ "%.2f"|format((days.ob_hours.get('OB3',0) or 0) + (days.ob_hours.get('OB4',0) or 0)) }}</td>
                <td data-label="OB5 Storhelg">{{ "%.2f"|format(days.ob_hours.get('OB5',0) or 0) }}</td>
                <td data-label="On-call hours">{{ "%.2f"|format(days.oncall_hours or 0) }}</td>
                <td data-label="On-call pay">{{ "%.2f"|format(days.oncall_pay or 0) }} kr</td>
                <td data-label="OT pay">{{ "%.2f"|format(days.ot_pay or 0) }} kr</td>
                {% endif %}
            </tr>
        </tbody>
    </table>

    {% if vacation_month %}
    <div style="background: rgba(100,200,255,0.08); border: 1px solid var(--accent); padding: 10px 16px; border-radius: var(--radius); margin-bottom: 16px; font-size: 0.9rem;">
        <strong>{{ vacation_month.days }} semesterdag{{ 'ar' if vacation_month.days != 1 else '' }}</strong> denna m&aring;nad
        &rarr; semestertill&auml;gg: <strong style="color: var(--accent-2);">{{ "{:,.0f}".format(vacation_month.supplement_month).replace(",", " ") }} kr</strong>
        <span style="color: var(--muted);">({{ "%.0f"|format(vacation_month.supplement_per_day) }} kr/dag)</span>
    </div>
    {% endif %}

    {# Calendar grid view #}
    {% set weekday_names_short = ['Mån', 'Tis', 'Ons', 'Tor', 'Fre', 'Lör', 'Sön'] %}

    <table class="calendar-grid">
        <thead>
            <tr>
                {% for day_name in weekday_names_short %}
                    <th>{{ day_name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for week in calendar_grid %}
                <tr>
                    {% for day_data in week %}
                        {% set is_today = today is defined and day_data.date == today %}
                        {% set is_current = day_data.is_current_month %}

                        <td class="calendar-day {% if not is_current %}adjacent-month{% endif %} {% if is_today %}today-cell{% endif %}"
                            style="border-top: 4px solid {% if day_data.shift %}{{ day_data.shift.color }}{% else %}#333{% endif %};">

                            <div class="calendar-day-content">
                                <div class="calendar-day-header">
                                    <a href="/day/{{ person_id }}/{{ day_data.date.year }}/{{ day_data.date.month }}/{{ day_data.date.day }}"
                                       class="day-number">
                                        {{ day_data.date.day }}
                                    </a>
                                    {% if storhelg_dates is defined and day_data.date in storhelg_dates %}
                                        <span class="badge badge-ob5" style="font-size:0.6rem;padding:1px 4px;">S</span>
                                    {% elif holiday_dates is defined and day_data.date in holiday_dates %}
                                        <span class="badge badge-ob4" style="font-size:0.6rem;padding:1px 4px;">H</span>
                                    {% endif %}
                                    {% if day_data.date.weekday() == 0 %}
                                        <span class="rotation-week-small">v{{ day_data.date.isocalendar()[1] }}</span>
                                    {% elif day_data.date.weekday() == 6 and day_data.rotation_week %}
                                        {% if day_data.rotation_length %}
                                            <span class="rotation-week-small">r-v{{ day_data.rotation_week }}/{{ day_data.rotation_length }}</span>
                                        {% else %}
                                            <span class="rotation-week-small">r-v{{ day_data.rotation_week }}</span>
                                        {% endif %}
                                    {% endif %}
                                </div>

                                <div class="calendar-day-body">
                                    {% if day_data.shift %}
                                        <span class="badge calendar-badge"
                                              style="background: {{ day_data.shift.color }}; color: {{ day_data.shift.color | contrast }};">
                                            {{ day_data.shift.code }}
                                        </span>
                                    {% else %}
                                        <span class="badge badge-off calendar-badge">OFF</span>
                                    {% endif %}

                                    {% if day_data.shift and day_data.shift.code != 'OC' %}
                                        {% if day_data.shift.code == 'OT' and day_data.start and day_data.end %}
                                            <div class="calendar-time">{{ day_data.start | time_format }} - {{ day_data.end | time_format }}</div>
                                        {% elif day_data.shift.start_time is not none %}
                                            <div class="calendar-time">{{ day_data.shift.start_time }} - {{ day_data.shift.end_time }}</div>
                                        {% endif %}
                                    {% endif %}

                                    {% if day_data.coworkers and day_data.shift.code != 'OFF' %}
                                        <div class="coworkers-list">Med: {{ day_data.coworkers | join(', ') }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {# ── Detailed OB / Beredskap / OT breakdown ── #}
    {% if show_salary %}
    <div style="margin-top: 1.5rem; text-align: center;">
        <button class="btn secondary" id="breakdown-toggle" onclick="toggleBreakdown()">
            Visa detaljerad uppdelning
        </button>
    </div>

    <div id="breakdown-section" style="display: none; margin-top: 1rem;">
        <h3 style="margin-bottom: 0.5rem;">OB / Beredskap / &Ouml;vertid per dag</h3>
        <div style="overflow-x: auto;">
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th class="th_left">Datum</th>
                        <th class="th_left">Dag</th>
                        <th class="th_left">Typ</th>
                        <th class="th_right">Start</th>
                        <th class="th_right">Slut</th>
                        <th class="th_right">Norm</th>
                        <th class="th_right">OB1(x1,12)</th>
                        <th class="th_right">OB2(x1,18)</th>
                        <th class="th_right">OB3(x1,24)</th>
                        <th class="th_right">OB4(x1,24)</th>
                        <th class="th_right">OB5(x1,47)</th>
                        <th class="th_right">B.Vardag(75)</th>
                        <th class="th_right">B.Helg(97)</th>
                        <th class="th_right">B.Helgdag(112)</th>
                        <th class="th_right">B.Storhelg(192)</th>
                        <th class="th_right">ÖT(x2)</th>
                    </tr>
                </thead>
                <tbody>
                    {% set ns = namespace(
                        tot_norm=0, tot_ob1=0, tot_ob2=0, tot_ob3=0, tot_ob4=0, tot_ob5=0,
                        tot_vardag=0, tot_helg=0, tot_helgdag=0, tot_storhelg=0, tot_ot=0,
                        has_rows=false
                    ) %}

                    {% for d in days.days %}
                        {% set ob1 = d.ob_hours.get('OB1', 0) or 0 %}
                        {% set ob2 = d.ob_hours.get('OB2', 0) or 0 %}
                        {% set ob3 = d.ob_hours.get('OB3', 0) or 0 %}
                        {% set ob4 = d.ob_hours.get('OB4', 0) or 0 %}
                        {% set ob5 = d.ob_hours.get('OB5', 0) or 0 %}
                        {% set ob_sum = ob1 + ob2 + ob3 + ob4 + ob5 %}

                        {# Non-OB hours: shift hours minus OB hours (only for regular work shifts) #}
                        {% set is_work_shift = d.shift and d.shift.code not in ('OFF', 'OC', 'OT') %}
                        {% set norm = (d.hours - ob_sum) if is_work_shift and d.hours else 0 %}
                        {% if norm < 0 %}{% set norm = 0 %}{% endif %}

                        {% set oc_bd = d.oncall_details.get('breakdown', {}) if d.oncall_details else {} %}
                        {% set oc_vardag = (oc_bd.get('OC_WEEKDAY', {}).get('hours', 0) or 0) %}
                        {% set oc_helg = (oc_bd.get('OC_WEEKEND', {}).get('hours', 0) or 0)
                                       + (oc_bd.get('OC_WEEKEND_SAT', {}).get('hours', 0) or 0)
                                       + (oc_bd.get('OC_WEEKEND_SUN', {}).get('hours', 0) or 0)
                                       + (oc_bd.get('OC_WEEKEND_MON', {}).get('hours', 0) or 0) %}
                        {% set oc_helgdag = (oc_bd.get('OC_HOLIDAY', {}).get('hours', 0) or 0)
                                          + (oc_bd.get('OC_HOLIDAY_EVE', {}).get('hours', 0) or 0)
                                          + (oc_bd.get('OC_NATIONALDAGEN', {}).get('hours', 0) or 0) %}
                        {% set oc_storhelg = (oc_bd.get('OC_SPECIAL', {}).get('hours', 0) or 0) %}

                        {% set ot = d.ot_hours or 0 %}

                        {% set row_total = norm + ob_sum + oc_vardag + oc_helg + oc_helgdag + oc_storhelg + ot %}

                        {% if row_total > 0 %}
                            {% set ns.has_rows = true %}
                            {% set ns.tot_norm = ns.tot_norm + norm %}
                            {% set ns.tot_ob1 = ns.tot_ob1 + ob1 %}
                            {% set ns.tot_ob2 = ns.tot_ob2 + ob2 %}
                            {% set ns.tot_ob3 = ns.tot_ob3 + ob3 %}
                            {% set ns.tot_ob4 = ns.tot_ob4 + ob4 %}
                            {% set ns.tot_ob5 = ns.tot_ob5 + ob5 %}
                            {% set ns.tot_vardag = ns.tot_vardag + oc_vardag %}
                            {% set ns.tot_helg = ns.tot_helg + oc_helg %}
                            {% set ns.tot_helgdag = ns.tot_helgdag + oc_helgdag %}
                            {% set ns.tot_storhelg = ns.tot_storhelg + oc_storhelg %}
                            {% set ns.tot_ot = ns.tot_ot + ot %}

                            {# Shift type label and times #}
                            {% set shift_label = d.shift.label if d.shift and d.shift.label else (d.shift.code if d.shift else '') %}
                            {% if d.start and d.end %}
                                {% set t_start = d.start | time_format %}
                                {% set t_end = d.end | time_format %}
                            {% elif d.shift and d.shift.start_time %}
                                {% set t_start = d.shift.start_time %}
                                {% set t_end = d.shift.end_time %}
                            {% else %}
                                {% set t_start = '' %}
                                {% set t_end = '' %}
                            {% endif %}
                            {# För förlängningar: visa faktisk sluttid från OT-data #}
                            {% if d.ot_details and d.ot_details.get('is_extension') %}
                                {% set t_end = d.ot_details.end_time[:5] %}
                            {% endif %}

                            <tr>
                                <td class="td_left num">{{ d.date }}</td>
                                <td class="td_left">{{ d.weekday_name }}</td>
                                <td class="td_left">{{ shift_label }}</td>
                                <td class="td_right num">{{ t_start }}</td>
                                <td class="td_right num">{{ t_end }}</td>
                                <td class="td_right num">{% if norm %}{{ "%.1f"|format(norm) }}{% endif %}</td>
                                <td class="td_right num">{% if ob1 %}{{ "%.1f"|format(ob1) }}{% endif %}</td>
                                <td class="td_right num">{% if ob2 %}{{ "%.1f"|format(ob2) }}{% endif %}</td>
                                <td class="td_right num">{% if ob3 %}{{ "%.1f"|format(ob3) }}{% endif %}</td>
                                <td class="td_right num">{% if ob4 %}{{ "%.1f"|format(ob4) }}{% endif %}</td>
                                <td class="td_right num">{% if ob5 %}{{ "%.1f"|format(ob5) }}{% endif %}</td>
                                <td class="td_right num">{% if oc_vardag %}{{ "%.1f"|format(oc_vardag) }}{% endif %}</td>
                                <td class="td_right num">{% if oc_helg %}{{ "%.1f"|format(oc_helg) }}{% endif %}</td>
                                <td class="td_right num">{% if oc_helgdag %}{{ "%.1f"|format(oc_helgdag) }}{% endif %}</td>
                                <td class="td_right num">{% if oc_storhelg %}{{ "%.1f"|format(oc_storhelg) }}{% endif %}</td>
                                <td class="td_right num">{% if ot %}{{ "%.1f"|format(ot) }}{% endif %}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}

                    {% if not ns.has_rows %}
                        <tr>
                            <td colspan="16" style="text-align: center; color: var(--muted); padding: 1rem;">
                                Inga OB / beredskap / &ouml;vertid denna m&aring;nad
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
                {% if ns.has_rows %}
                <tfoot>
                    <tr>
                        <td class="td_left" colspan="1"><strong>Total</strong></td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td> </td>
                        <td class="td_right num"><strong>{% if ns.tot_norm %}{{ "%.1f"|format(ns.tot_norm) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_ob1 %}{{ "%.1f"|format(ns.tot_ob1) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_ob2 %}{{ "%.1f"|format(ns.tot_ob2) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_ob3 %}{{ "%.1f"|format(ns.tot_ob3) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_ob4 %}{{ "%.1f"|format(ns.tot_ob4) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_ob5 %}{{ "%.1f"|format(ns.tot_ob5) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_vardag %}{{ "%.1f"|format(ns.tot_vardag) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_helg %}{{ "%.1f"|format(ns.tot_helg) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_helgdag %}{{ "%.1f"|format(ns.tot_helgdag) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_storhelg %}{{ "%.1f"|format(ns.tot_storhelg) }}{% endif %}</strong></td>
                        <td class="td_right num"><strong>{% if ns.tot_ot %}{{ "%.1f"|format(ns.tot_ot) }}{% endif %}</strong></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>

    <script>
    function toggleBreakdown() {
        var section = document.getElementById('breakdown-section');
        var btn = document.getElementById('breakdown-toggle');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.textContent = 'D\u00f6lj detaljerad uppdelning';
        } else {
            section.style.display = 'none';
            btn.textContent = 'Visa detaljerad uppdelning';
        }
    }
    </script>
    {% endif %}

{{ super() }}

{% endblock %}
