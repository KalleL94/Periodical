{# app/templates/month.html #}
{% extends "base.html" %}

{% block page_content %}

    {# Compute prev/next month + year here in the template #}
    {% if month == 1 %}
        {% set prev_month = 12 %}
        {% set prev_year = year - 1 %}
    {% else %}
        {% set prev_month = month - 1 %}
        {% set prev_year = year %}
    {% endif %}

    {% if month == 12 %}
        {% set next_month = 1 %}
        {% set next_year = year + 1 %}
    {% else %}
        {% set next_month = month + 1 %}
        {% set next_year = year %}
    {% endif %}

    <div class="page-header">
        <div class="page-header-left">
            <a href="/month/{{ person_id }}?year={{ prev_year }}&month={{ prev_month }}"
               class="btn btn-primary">Previous month</a>

            <a href="/month/{{ person_id }}" class="btn btn-primary">Today</a>

            <a href="/month/{{ person_id }}?year={{ next_year }}&month={{ next_month }}"
               class="btn btn-primary">Next month</a>
        </div>

        <div class="page-header-right">
            {# Navigering mellan personer - endast för admin #}
            {% if user and user.role.value == 'admin' %}
                <a href="/month/{{ person_id - 1 if person_id != 1 else 10 }}?year={{ year }}&month={{ month }}" class="btn secondary">&lt-</a>
            {% endif %}
            <a href="/month?year={{ year }}&month={{ month }}" class="btn secondary">All</a>
            {% if user and user.role.value == 'admin' %}
                <a href="/month/{{ person_id + 1 if person_id != 10 else 1 }}?year={{ year }}&month={{ month }}" class="btn secondary">-&gt</a>
            {% endif %}
        </div>
    </div>

<h2 class="page-title">Month {{ month }} {{ year }} - {{ person_name }}</h2>


    {# Summary row - visa bara lönedata om show_salary #}
    <table class="summary">
        {% if show_salary %}
        <thead>
            <tr>
                <th>Net salary</th>
                <th>Gross salary</th>
                <th>Number of shifts</th>
                <th>Total hours</th>
                <th>Total OB pay</th>
                <th>Evening (OB1/150?)</th>
                <th>Night (OB2/151)</th>
                <th>Weekend (OB3+OB4/152)</th>
                <th>Holiday (OB5/153)</th>
                <th>On-call hours</th>
                <th>On-call pay</th>
                <th>OT pay</th>
            </tr>
        </thead>
        {% endif %}
        <tbody>
            {% set total_ob = (days.ob_pay.get('OB1',0) or 0) + (days.ob_pay.get('OB2',0) or 0)
                              + (days.ob_pay.get('OB3',0) or 0) + (days.ob_pay.get('OB4',0) or 0)
                              + (days.ob_pay.get('OB5',0) or 0) %}
            <tr>
                {% if show_salary %}
                <td data-label="Netto">{{ "%.0f"|format(days.netto_pay or 0) }}</td>
                <td data-label="Brutto">{{ "%.0f"|format(days.brutto_pay or 0) }}</td>
                {% endif %}
                <td data-label="Antal pass">{{ days.num_shifts }}</td>
                <td data-label="Timmar">{{ "%.2f"|format(days.total_hours or 0) }}</td>
                {% if show_salary %}
                <td data-label="Total OB">{{ "%.2f"|format(total_ob) }}</td>
                <td data-label="OB1 Kväll">{{ "%.2f"|format(days.ob_hours.get('OB1',0) or 0) }}</td>
                <td data-label="OB2 Natt">{{ "%.2f"|format(days.ob_hours.get('OB2',0) or 0) }}</td>
                <td data-label="OB3+4 Helg">{{ "%.2f"|format((days.ob_hours.get('OB3',0) or 0) + (days.ob_hours.get('OB4',0) or 0)) }}</td>
                <td data-label="OB5 Storhelg">{{ "%.2f"|format(days.ob_hours.get('OB5',0) or 0) }}</td>
                <td data-label="On-call hours">{{ "%.2f"|format(days.oncall_hours or 0) }}</td>
                <td data-label="On-call pay">{{ "%.2f"|format(days.oncall_pay or 0) }} kr</td>
                <td data-label="OT pay">{{ "%.2f"|format(days.ot_pay or 0) }} kr</td>
                {% endif %}
            </tr>
        </tbody>
    </table>

    {# Calendar grid view #}
    {% set weekday_names_short = ['Mån', 'Tis', 'Ons', 'Tor', 'Fre', 'Lör', 'Sön'] %}

    {# Get first day of month and calculate its weekday (0=Monday, 6=Sunday) #}
    {% set first_day = days.days[0].date.replace(day=1) %}
    {% set first_weekday = first_day.weekday() %}
    {# Calculate actual number of days in the month #}
    {% if month in [1, 3, 5, 7, 8, 10, 12] %}
        {% set num_days = 31 %}
    {% elif month in [4, 6, 9, 11] %}
        {% set num_days = 30 %}
    {% elif month == 2 %}
        {# Check for leap year #}
        {% if (year % 4 == 0 and year % 100 != 0) or (year % 400 == 0) %}
            {% set num_days = 29 %}
        {% else %}
            {% set num_days = 28 %}
        {% endif %}
    {% endif %}

    {# Calculate total cells needed (weeks * 7) #}
    {% set total_cells = ((first_weekday + num_days + 6) // 7) * 7 %}

    <table class="calendar-grid">
        <thead>
            <tr>
                {% for day_name in weekday_names_short %}
                    <th>{{ day_name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for week_offset in range(0, total_cells, 7) %}
                <tr>
                    {% for day_offset in range(7) %}
                        {% set cell_index = week_offset + day_offset %}
                        {% set day_num = cell_index - first_weekday + 1 %}

                        {% if day_num < 1 or day_num > num_days %}
                            {# Empty cell for days outside this month #}
                            <td class="calendar-day empty"></td>
                        {% else %}
                            {# Valid day in this month - find the correct day by matching the date #}
                            {% set ns = namespace(d=none) %}
                            {% for day_obj in days.days %}
                                {% if day_obj.date.day == day_num %}
                                    {% set ns.d = day_obj %}
                                {% endif %}
                            {% endfor %}

                            {% if ns.d %}
                                {% set is_today = today is defined and ns.d.date == today %}

                                <td class="calendar-day {% if is_today %}today-cell{% endif %}"
                                    style="border-top: 4px solid {% if ns.d.shift %}{{ ns.d.shift.color }}{% else %}#333{% endif %};">

                                    <div class="calendar-day-content">
                                        <div class="calendar-day-header">
                                            <a href="/day/{{ person_id }}/{{ ns.d.date.year }}/{{ ns.d.date.month }}/{{ ns.d.date.day }}"
                                               class="day-number">
                                                {{ day_num }}
                                            </a>
                                            {% if ns.d.date.weekday() == 0 %}
                                                <span class="rotation-week-small">v{{ ns.d.date.isocalendar()[1] }}</span>
                                            {% elif ns.d.date.weekday() == 6 %}
                                                <span class="rotation-week-small">r-v{{ ns.d.rotation_week }}</span>
                                            {% endif %}
                                        </div>

                                        <div class="calendar-day-body">
                                            {% if ns.d.shift %}
                                                <span class="badge calendar-badge"
                                                      style="background: {{ ns.d.shift.color }}; color: {{ ns.d.shift.color | contrast }};">
                                                    {{ ns.d.shift.code }}
                                                </span>
                                            {% else %}
                                                <span class="badge badge-off calendar-badge">OFF</span>
                                            {% endif %}

                                            {% if ns.d.shift and ns.d.shift.code != 'OC' %}
                                                {% if ns.d.shift.code == 'OT' and ns.d.start and ns.d.end %}
                                                    <div class="calendar-time">{{ ns.d.start.strftime('%H:%M') }} - {{ ns.d.end.strftime('%H:%M') }}</div>
                                                {% elif ns.d.shift.start_time is not none %}
                                                    <div class="calendar-time">{{ ns.d.shift.start_time }} - {{ ns.d.shift.end_time }}</div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                            {% else %}
                                <td class="calendar-day empty"></td>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

{{ super() }}

{% endblock %}
