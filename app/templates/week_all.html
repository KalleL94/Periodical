{# app/templates/week_all.html #}
{% extends "base.html" %}

{% block page_content %}

<div class="page-header">
    <div class="page-header-left">
        <a href="/week?year={{ year - 1 }}&week={{ week }}" class="btn btn-primary">Previous year</a>
        <a href="/week?year={{ prev_year }}&week={{ prev_week }}" class="btn btn-primary">Prev week</a>
        <a href="/week" class="btn btn-primary">Today</a>
        <a href="/week?year={{ next_year }}&week={{ next_week }}" class="btn btn-primary">Next week</a>
        <a href="/week?year={{ year + 1 }}&week={{ week }}" class="btn btn-primary">Next year</a>
    </div>

    <div class="page-header-right">
        {# Visa bara länk till egen week-sida, eller alla om admin #}
        {% if user and user.role.value == 'admin' %}
            {% for i in range(1, 11) %}
                <a href="/week/{{ i }}?year={{ year }}&week={{ week }}" class="btn secondary">
                    {{ i }}
                </a>
            {% endfor %}
        {% elif user %}
            <a href="/week/{{ user.id }}?year={{ year }}&week={{ week }}" class="btn secondary">Min vecka</a>
        {% endif %}
    </div>
</div>

<h2 class="page-title">Week {{ week }} {{ year }} - All persons</h2>

{# Grid calendar view: persons as rows, days as columns #}
{% set weekday_names_short = ['Mån', 'Tis', 'Ons', 'Tor', 'Fre', 'Lör', 'Sön'] %}

<div class="week-grid-wrapper">
    <table class="week-grid-all">
        <thead>
            <tr>
                <th class="person-header-column">Person</th>
                {% for day in days %}
                    <th class="day-column {% if today is defined and day.date == today %}today-column{% endif %}">
                        <div>{{ weekday_names_short[day.date.weekday()] }}</div>
                        <div class="date-small">{{ day.date.day }}/{{ day.date.month }}</div>
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {# Build rows for each person (1-10) #}
            {% for person_id in range(1, 11) %}
                <tr class="person-row">
                    {# Person name column (sticky left) #}
                    <td class="person-name-cell">
                        {% if days and days|length > 0 and days[0].persons|length >= person_id %}
                            {% set person_data = days[0].persons[person_id - 1] %}
                            {% if user and (user.role.value == 'admin' or user.id == person_id) %}
                                <a href="/week/{{ person_id }}?year={{ year }}&week={{ week }}">
                                    {{ person_data.person_name }}<br>
                                    <small>(#{{ person_id }})</small>
                                </a>
                            {% else %}
                                {{ person_data.person_name }}<br>
                                <small>(#{{ person_id }})</small>
                            {% endif %}
                        {% else %}
                            Person {{ person_id }}
                        {% endif %}
                    </td>

                    {# Day cells for this person #}
                    {% for day in days %}
                        {# Find this person's shift for this day #}
                        {% set ns = namespace(person=none) %}
                        {% for p in day.persons %}
                            {% if p.person_id == person_id %}
                                {% set ns.person = p %}
                            {% endif %}
                        {% endfor %}

                        {% set is_today = today is defined and day.date == today %}

                        <td class="shift-cell {% if is_today %}today-cell{% endif %}"
                            style="border-left: 4px solid {% if ns.person and ns.person.shift %}{{ ns.person.shift.color }}{% else %}#ddd{% endif %};">

                            {% if ns.person and ns.person.shift %}
                                {# Länka till day-sida bara om admin eller egen #}
                                {% if user and (user.role.value == 'admin' or user.id == person_id) %}
                                    <a href="/day/{{ person_id }}/{{ day.date.year }}/{{ day.date.month }}/{{ day.date.day }}"
                                       class="shift-link"
                                       style="color: var(--text); text-decoration: none;">
                                {% endif %}

                                <div class="shift-name" style="color: {{ ns.person.shift.color }}; font-weight: 500; font-size: 0.85rem;">
                                    {% if ns.person.shift.code == 'SEM' %}
                                        Semester
                                    {% elif ns.person.shift.code == 'OT' %}
                                        Övertid
                                    {% elif ns.person.shift.code == 'OC' %}
                                        Beredskap
                                    {% elif ns.person.shift.code == 'OFF' %}
                                        Ledig
                                    {% else %}
                                        {{ ns.person.shift.label or ns.person.shift.code }}
                                    {% endif %}
                                </div>

                                {# Show times for OT shifts #}
                                {% if ns.person.shift.code == 'OT' and ns.person.start and ns.person.end %}
                                    <div class="shift-time" style="color: var(--muted); font-size: 0.7rem; margin-top: 2px;">
                                        {{ ns.person.start.strftime('%H:%M') }}-{{ ns.person.end.strftime('%H:%M') }}
                                    </div>
                                {% endif %}

                                {% if user and (user.role.value == 'admin' or user.id == person_id) %}
                                    </a>
                                {% endif %}
                            {% else %}
                                <span class="shift-name" style="color: var(--muted); font-size: 0.85rem;">Ledig</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
